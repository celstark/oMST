<!DOCTYPE html>
<html>
  <!--
  Author: Craig Stark

  Collects demographic information and then advances to the next task in the list

  8/30/23 (CELS): Added getID() to come up with a good sid
  9/7/23 (CELS): Fixing order / trialindex
  10/12/23 (CELS): Add browser info logging
  10/23/23 (CELS): Multi-lang support using Honeycomb style language file  

-->
<head>
  <meta http-equiv="Content-Security-Policy" content="default-src 'self' data: gap:  'unsafe-inline' 'unsafe-eval' 
    https://fonts.gstatic.com http://www.stark-labs.com/exp/jsPsych/mobile_cMST/append_log.php http://www.stark-labs.com/exp/jsPsych/mobile_cMST/write_data_file.php; 
  style-src 'self' 'unsafe-inline' https://fonts.googleapis.com/css; media-src *; 
  img-src 'self' data: content:;">

  <script type="text/javascript" src="jatos.js"></script>
  <script type="text/javascript" src="js/index.js"></script>
  <script src="js/jspsych_731/dist/jspsych.js"></script>
  <script src="js/jspsych_731/dist/plugin-survey-html-form.js"></script>
  <script src="js/jquery-3.1.1.min.js"></script>
  <script src="js/jspsych_731/dist/plugin-browser-check.js"></script>
  <link rel="stylesheet" href="css/jspsych.css"></link>
  <style>
  .jspsych-display-element {
    font-size: 200%;
  }
  .jspsych-btn {
    font-size: 125%;
  }
  body {
    background-color: #fff9e0;
  }

  .jspsych-btn {
    font-size: 150%;
  }

  .image-btn-wrapper {
    display: inline-block;
    position: relative;
    margin: 0.5em;
  }

  .image-btn {
    width: 15vw;
    height: auto;
    border: none;
    display: block;
  }

  .smallScreen .image-btn {
    width: 20vw !important;
  }

  .mobile .image-btn {
    width: 35vw;
  }

  .tablet .image-btn {
    width: 25vw;
  }

  .image-btn-text {
    position: absolute;
    top: 38%;
    left: 50%;
    transform: translate(-50%, -50%);
    pointer-events: none;
    width: 100%;
    height: auto; /* scales with wrapper if you want */
  }

  .image-btn-text text {
    font-family: 'Comic Relief', sans-serif;
    font-size: 1.30em;
    fill: #fff8d6;       /* inner text color */
    stroke: #5d2b12;     /* outline color */
    stroke-width: 9;     /* outline thickness */
    font-weight: bold;
    letter-spacing: 0.08em;
    text-anchor: middle;
    dominant-baseline: middle;
    paint-order: stroke fill;
    stroke-linejoin: round;
    stroke-linecap: round;
  }
  
  .image-btn-wrapper.pressed .image-btn-text{
    transform: translate(-50%, -40%) !important;
  }

  .mobile .image-btn-text text{
    stroke-width: 11;
    font-size: 1.3em;
  }

  .prompt_text {
    font-family: 'Comic Relief', sans-serif;
    font-size: 1.2em;
    color: #5d2b12;
    font-weight: normal;
    line-height: 1.2;
  }

  .mobile  .prompt_text {
    font-size: 1em;
  }

  #jspsych-html-button-response-stimulus {
    font-family: 'Comic Relief', sans-serif;
    font-size: 1.5em;
    color: #5d2b12;
    line-height: 1.2;
  }

  .no-default-btn .jspsych-btn {
    display: none !important;
  }

  input[type="radio"] {
    appearance: none;
    -webkit-appearance: none;
    background-color: #fff8d6;
    width: 22px;
    height: 22px;
    border: 3px solid #5d2b12;
    border-radius: 50%;
    cursor: pointer;
    display: inline-block;
    position: relative;
  }

  input[type="radio"]:checked::after {
    content: "";
    position: absolute;
    top: 50%;
    left: 50%;
    transform: translate(-50%, -50%);
    width: 12px;
    height: 12px;
    background: #5d2b12;
    border-radius: 50%;
  }

  .mobile input[type="radio"] {
    width: 30px;
    height: 30px;
    border: 4px solid #5d2b12;
  }

  .mobile input[type="radio"]:checked::after {
    width: 17px;
    height: 17px;
  }

  .jspsych-display-element input[type="text"] {
    height: 24px;
    width: 240px;
    font-size: 22px;
    color: #5d2b12;
    font-family: "Comic Sans MS", "Comic Neue", cursive;
    border: 2px solid #5d2b12;
    border-radius: 4px;
    vertical-align: middle;
    line-height: 1.2;
  }

  .jspsych-display-element input[type="text"]:focus {
    border: 2px solid #5d2b12 !important;
    border-color: #5d2b12 !important;
    -webkit-box-shadow: none;
    box-shadow: none;
  }

  .jspsych-display-element input[type="text"]:focus-visible {
    border: 2px solid #5d2b12 !important;
    border-color: #5d2b12 !important;
  }

  .mobile.jspsych-display-element input[type="text"] {
    height: 48px;
    font-size: 44px;
  }


  </style>
</head>
<body>

</body>
<script>
const isMobile = /Mobi|Android/i.test(navigator.userAgent);
const isTablet = window.innerWidth >= 600 && window.innerWidth <= 1024 && !isMobile;
const smallScreen = window.innerHeight <= 800 && window.innerWidth <= 1440 && !isMobile && !isTablet;
const canvasWidth = isMobile ? window.innerWidth * 0.9 : window.innerWidth * .9;
const canvasHeight = isMobile ? window.innerHeight * 0.7 : smallScreen ? window.innerHeight * 0.8 : window.innerHeight * .65;
const fontScale = isMobile ? 1.5 : 1.0;
const stimScale = isMobile ? 0.9 : smallScreen ? 0.85: isTablet ? 0.8 : 0.9;
document.body.classList.add(isMobile ? 'mobile' : 'desktop');
if (smallScreen) {document.body.classList.add('smallScreen');}
if (isTablet) {document.body.classList.add('tablet');}
function getID() {
  // Try to get a reasonable ID code for this person
  // URL > studySession > workerID
  var sid=jatos.urlQueryParameters.sid;
  if (sid == undefined) {
    sid=jatos.studySessionData['sid'];
  }
  if (typeof sid == 'undefined') {
    if (typeof jatos.workerId !== 'undefined') { // At least try the workerID 
      sid = jatos.workerId;
    }
    else { sid=1234; }
  }
  return sid
}

function waitFor(conditionFunction) {
  const poll = resolve => {
  if(conditionFunction()) resolve();
    else setTimeout(_ => poll(resolve), 400);
  }
  return new Promise(poll)
}

jatos.onLoad(async function() {
  var sid=getID();
  //console.log('In demog, sid= ' + sid);
  var lang='en';
  if (typeof jatos.studySessionData['lang'] !== 'undefined') {
    lang=jatos.studySessionData['lang'];
  }
  if (jatos.studyJsonInput && typeof jatos.studyJsonInput['lang'] !== 'undefined' ) { 
    lang=jatos.studyJsonInput['lang']
  }
  if (jatos.batchJsonInput && typeof jatos.batchJsonInput['lang'] !== 'undefined' ) { 
    lang=jatos.batchJsonInput['lang']
  }
  // load honeycomb version of lang file
  console.log('loading json lang')
  var langfile='lang/omst_'+lang+'.json';
  var json_prompts=null;
  $.getJSON(langfile,function( data ) {
    json_prompts=data;
    console.debug(langfile + ' loaded...ish');
  });
  await waitFor(_ => json_prompts !== null);
  console.log(json_prompts['task']['name'])
  let prompts=json_prompts['demog']  // Load in this phase's section

  var jsPsych = initJsPsych({
    on_finish: function() {
      var result = jsPsych.data.get().json();
      var order=jatos.studySessionData["order"];
      jatos.studySessionData["taskindex"] += 1;
      var expdata = jsPsych.data.get().json();
      if (typeof order === 'undefined') {
        // We don't have an 'order' setup, so assume it's 1-N  (e.g., we didn't use the setup.html in this exp)
        console.log('faking an order')
        order=Array(jatos.componentList.length).fill().map((e,i)=>i+1);
        jatos.studySessionData["taskindex"]=jatos.componentPos;
      }
      //jatos.submitResultData(result, jatos.startNextComponent);
      if (typeof order === 'undefined' || order.length == jatos.studySessionData["taskindex"]) {         // we're done?
        // Check if this came from SONA - should have URL.sid and .sona
        if (typeof jatos.urlQueryParameters.sid === 'undefined' || typeof jatos.urlQueryParameters.sona === 'undefined' ||
          typeof jatos.studyJsonInput['experiment_id'] === 'undefined' || typeof jatos.studyJsonInput['credit_token'] === 'undefined') {  // not SONA - just finish
          jatos.submitResultData(expdata,jatos.endStudy);
        }
        else { // SONA - give credit
          var redirect='https://uci.sona-systems.com/webstudy_credit.aspx?experiment_id='+jatos.studyJsonInput['experiment_id']+
          '&credit_token='+jatos.studyJsonInput['credit_token']+'&survey_code='+jatos.urlQueryParameters.sid;
          jatos.endStudyAndRedirect(redirect,expdata);
        }
      }
      else { // submit data and start the next  
        jatos.submitResultData(expdata, () => { jatos.startComponentByPos(order[jatos.studySessionData["taskindex"]]) });
      }
    }
  });

  let date = new Date(); 
  jsPsych.data.addProperties({
       subject: sid,
       task: 'demographics',
       date: date.toLocaleDateString(),
       urlid: jatos.urlQueryParameters.sid,
  });

  var browserinfo = {
    type: jsPsychBrowserCheck
  };

  var demogform = {
    type: jsPsychSurveyHtmlForm,
    preamble: `<p class="prompt_text ${lang}">${prompts['preamble']}</p>`,
    css_classes: ['no-default-btn'],
  html: function() {
      const fontSize = isMobile ? '48px' : '24px';
      const height = isMobile ? '48px' : '24px';

      return `
        <div style="text-align: left; font-size: ${fontSize}; line-height: 110%">
          <p class="prompt_text ${lang}"><b>${prompts['age']}</b> 
            <input class="age_input" name="age" type="text" required />
          </p>

          <p class="prompt_text ${lang}"><b>${prompts['gender']['prompt']}</b><br>
            <input type="radio" id="male" name="gender" value="male" style="margin-left: 50px" required>
            <label for="male">${prompts['gender']['m']}</label><br>
            <input type="radio" id="female" name="gender" value="female" style="margin-left: 50px">
            <label for="female">${prompts['gender']['f']}</label>
          </p>

          <p class="prompt_text ${lang}"><b>${prompts['ethnicity']['prompt']}</b><br>
            <input type="radio" id="hispanic" name="ethnicity" value="hispanic" style="margin-left: 50px" required>
            <label for="hispanic">${prompts['ethnicity']['h']}</label><br>
            <input type="radio" id="nonhispanic" name="ethnicity" value="nonhispanic" style="margin-left: 50px">
            <label for="nonhispanic">${prompts['ethnicity']['nh']}</label>
          </p>

          <p class="prompt_text ${lang}"><b>${prompts['race']['prompt']}</b><br>
            <input type="radio" id="nativeamerican" name="race" value="nativeamerican" style="margin-left: 50px" required>
            <label for="nativeamerican">${prompts['race']['ai']}</label><br>
            <input type="radio" id="asian" name="race" value="asian" style="margin-left: 50px">
            <label for="asian">${prompts['race']['a']}</label><br>
            <input type="radio" id="black" name="race" value="black" style="margin-left: 50px">
            <label for="black">${prompts['race']['b']}</label><br>
            <input type="radio" id="nativehawaiian" name="race" value="nativehawaiian" style="margin-left: 50px">
            <label for="nativehawaiian">${prompts['race']['nh']}</label><br>
            <input type="radio" id="white" name="race" value="white" style="margin-left: 50px">
            <label for="white">${prompts['race']['w']}</label><br>
            <input type="radio" id="more" name="race" value="more" style="margin-left: 50px">
            <label for="more">${prompts['race']['m']}</label>
          </p>

          <p class="prompt_text ${lang}"><b>${prompts['handedness']['prompt']}</b><br>
            <input type="radio" id="left" name="handedness" value="left" style="margin-left: 50px" required>
            <label for="left">${prompts['handedness']['l']}</label><br>
            <input type="radio" id="right" name="handedness" value="right" style="margin-left: 50px">
            <label for="right">${prompts['handedness']['r']}</label><br>
            <input type="radio" id="ambi" name="handedness" value="ambi" style="margin-left: 50px">
            <label for="ambi">${prompts['handedness']['a']}</label>
          </p>
        </div>

        <div class="image-btn-wrapper">
          <input type="image" src="img/assets/blank_green.png"
                class="image-btn" id="id_continue_btn">
          <svg class="image-btn-text" viewBox="0 0 266 160">
            <text x="50%" y="50%">Continue</text>
          </svg>
        </div>
      `;
    },
  on_load: function() {
    // grab the form element
    const form = document.querySelector('form');
    // grab the custom button input
    const btn = form.querySelector('.image-btn-wrapper input');

    btn.addEventListener('click', e => {
      e.preventDefault();  // prevent weird image input default
      form.requestSubmit(); // properly submit the form
    });

    document.addEventListener('mouseover', handlePress, true);
    document.addEventListener('mouseleave', handleRelease, true);
    document.addEventListener('touchstart', handlePress, { passive: true });
    document.addEventListener('touchend', handleRelease);
    document.addEventListener('mouseup', handleRelease);
  },

  on_finish: function(data) {
    document.removeEventListener('mouseover', handlePress, true);
    document.removeEventListener('mouseleave', handleRelease, true);
    document.removeEventListener('touchstart', handlePress);
    document.removeEventListener('touchend', handleRelease);
    document.removeEventListener('mouseup', handleRelease);

    console.log(data.response);
  }
  }

  let activeBtn = null;

  function handlePress(e) {
    const wrapper = e.target.closest('.image-btn-wrapper');
    if (!wrapper) return;

    const btn = wrapper.querySelector('.image-btn');
    const origSrc = btn.dataset.orig || btn.src;
    const pressedSrc = btn.dataset.pressed || origSrc.replace('.png', '_pressed.png');

    btn.dataset.orig = origSrc;
    btn.dataset.pressed = pressedSrc;

    btn.src = pressedSrc;
    wrapper.classList.add('pressed');

    activeBtn = btn;  // remember which button is pressed
  }

  function handleRelease(e) {
    if (!activeBtn) {
      return; // nothing to release
    }
    const wrapper = activeBtn.closest('.image-btn-wrapper');
    activeBtn.src = activeBtn.dataset.orig;
    wrapper.classList.remove('pressed');

    activeBtn = null; // reset
  }

  var timeline = [browserinfo, demogform];
  jsPsych.run(timeline);

  
});
</script>

</html>
