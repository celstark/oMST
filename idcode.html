<!DOCTYPE html>
<html>
  <!--
  Author: Craig Stark

  Collects an ID code

  2/8/23 (CELS): Converted to jsPsych7

-->
<head>
  <meta http-equiv="Content-Security-Policy" content="default-src 'self' data: gap:  'unsafe-inline' 'unsafe-eval' 
    https://fonts.gstatic.com http://www.stark-labs.com/exp/jsPsych/mobile_cMST/append_log.php http://www.stark-labs.com/exp/jsPsych/mobile_cMST/write_data_file.php; 
  style-src 'self' 'unsafe-inline' https://fonts.googleapis.com/css; media-src *; 
  img-src 'self' data: content:;">

  <script type="text/javascript" src="jatos.js"></script>
  <script type="text/javascript" src="js/index.js"></script>
  <script src="js/jspsych_731/dist/jspsych.js"></script>
  <script src="js/jspsych_731/dist/plugin-survey-html-form.js"></script>
  <link rel="stylesheet" href="js/jspsych_731/dist/jspsych.css"></link>
  <style>
    body {
      margin:0;
      height:100vh;
      display:flex;
      flex-direction:column;
      justify-content:center;
      align-items:center;
      text-align:center;
      background-color: #fff9e0;
    }

    .jspsych-display-element {
      font-size: 200%;
    }
    .jspsych-btn {
      font-size: 150%;
    }

    .image-btn-wrapper {
      display: inline-block;
      position: relative;
      margin: 0.5em;
    }

    .image-btn {
      width: 15vw;
      height: auto;
      border: none;
      display: block;
    }

    .smallScreen .image-btn {
      width: 20vw !important;
    }

    .mobile .image-btn {
      width: 35vw;
    }

    .tablet .image-btn {
      width: 25vw;
    }

    .image-btn-text {
      position: absolute;
      top: 38%;
      left: 50%;
      transform: translate(-50%, -50%);
      pointer-events: none;
      width: 100%;
      height: auto; /* scales with wrapper if you want */
    }

    .image-btn-text text {
      font-family: 'Comic Relief', sans-serif;
      font-size: 1.35em;
      fill: #fff8d6;       /* inner text color */
      stroke: #5d2b12;     /* outline color */
      stroke-width: 10;     /* outline thickness */
      font-weight: bold;
      letter-spacing: 0.08em;
      text-anchor: middle;
      dominant-baseline: middle;
      paint-order: stroke fill;
      stroke-linejoin: round;
      stroke-linecap: round;
    }
    
    .image-btn-wrapper.pressed .image-btn-text{
      transform: translate(-50%, -40%) !important;
    }

    .mobile .image-btn-text text{
      stroke-width: 11;
      font-size: 1.3em;
    }

    .image-btn-text.kr text,
    .image-btn-text.ru text{
      font-size: 0.9em;
      stroke-width: 8;
    }

    .image-btn-text.nl  text{
      font-size: 0.8em;
      stroke-width: 8;
    }
    
    .mobile .image-btn-text.kr text {
      font-size: 0.9em;
      stroke-width: 9;
    }

    .mobile .image-btn-text.nl text {
      font-size: 0.8em;
      stroke-width: 8;
    }

    .mobile .image-btn-text.ru text {
      font-size: 1.0em;
      stroke-width: 10;
    }
    
    .tablet .image-btn-text.kr text {
      font-size: 1em;
      stroke-width: 8;
    }

    .tablet .image-btn-text.ru text {
      font-size: 1.0em;
      stroke-width: 10;
    }

    body {
      background-color: #fff9e0;
    }

    .prompt_text {
      font-family: 'Comic Relief', sans-serif;
      font-size: 2.6em;
      color: #5d2b12;
      font-weight: normal;
      line-height: 1.2;
    }

    .mobile  .prompt_text {
      font-size: 3em;
    }

    .mobile .prompt_text.nl {
      font-size: 1.8em;
    }

    .mobile .prompt_text.ru {
      font-size: 1.6em;
    }

    .tablet .prompt_text{
      font-size: 1.2em;
    }

    .smallScreen .prompt_text {
      font-size: 2.6em;
    }

    .tablet .prompt_text.intro {
      font-size: 2.6em;
    }

    .mobile .prompt_text.es.intro,
    .mobile .prompt_text.nl.intro {
      font-size: 1.8em;
    }

    .mobile .prompt_text.ru.intro {
      font-size: 1.8em;
    }

    .smallScreen .prompt_text.ru.intro {
      font-size: 0.9em;
    }

    #jspsych-html-button-response-stimulus {
      font-family: 'Comic Relief', sans-serif;
      font-size: 1.5em;
      color: #5d2b12;
      line-height: 1.2;
    }
    
    .jspsych-categorize-image-buttons-stimulus {
      width: 15em;
      height: auto;
    }

    .mobile .jspsych-categorize-image-buttons-stimulus {
      width: 25em;
      height: auto;
    }

    .smallScreen .jspsych-categorize-image-buttons-stimulus {
      width: 10em;
      height: auto;
    }

    .idcode_text {
      font-size: 1.5em !important;
    }

    .idcode {
      height: 1.3em !important;
      font-size: 1.3em !important;
      color: #5d2b12;
      width: 10em !important;
      padding: 0 0.3em !important;
      border: 2px solid #5d2b12 !important;
      border-radius: 4px !important;
    }

    .idcode:focus {
      border-color:#5d2b12;
    }

    .mobile .idcode_text {
      font-size: 1.5em !important;
    }

    .mobile .idcode {
      height: 1.5em !important;
      font-size: 1.5em !important;
      width: 10em !important;
      padding: 0 0.3em !important;
      border: 2px solid #5d2b12 !important;
      border-radius: 4px !important;
    }

    .smallScreen .idcode_text {
      font-size: 1.5em !important;
    }

    .smallScreen .idcode {
      height: 1.3em !important;
      font-size: 1.3em !important;
      width: 10em !important;
      padding: 0 0.3em !important;
      border: 2px solid #5d2b12 !important;
      border-radius: 4px !important;
    }
  </style>
</head>
<body>

</body>
<script>

jatos.onLoad(function() {
  var jsPsych = initJsPsych({
    on_finish: function() {
      var result = jsPsych.data.get().json();
      var order=jatos.studySessionData["order"];
      jatos.studySessionData["taskindex"] += 1;
      var expdata = jsPsych.data.get().json();
      if (typeof order === 'undefined') {
        // We don't have an 'order' setup, so assume it's 1-N  (e.g., we didn't use the setup.html in this exp)
        console.log('faking an order')
        order=Array(jatos.componentList.length).fill().map((e,i)=>i+1);
        jatos.studySessionData["taskindex"]=jatos.componentPos;
      }
      //jatos.submitResultData(result, jatos.startNextComponent);
      if (typeof order === 'undefined' || order.length == jatos.studySessionData["taskindex"]) {         // we're done?
        // Check if this came from SONA - should have URL.sid and .sona
        if (typeof jatos.urlQueryParameters.sid === 'undefined' || typeof jatos.urlQueryParameters.sona === 'undefined' ||
          typeof jatos.studyJsonInput['experiment_id'] === 'undefined' || typeof jatos.studyJsonInput['credit_token'] === 'undefined') {  // not SONA - just finish
          jatos.submitResultData(expdata,jatos.endStudy);
        }
        else { // SONA - give credit
          var redirect='https://uci.sona-systems.com/webstudy_credit.aspx?experiment_id='+jatos.studyJsonInput['experiment_id']+
          '&credit_token='+jatos.studyJsonInput['credit_token']+'&survey_code='+jatos.urlQueryParameters.sid;
          jatos.endStudyAndRedirect(redirect,expdata);
        }
      }
      else { // submit data and start the next  
        jatos.submitResultData(expdata, () => { jatos.startComponentByPos(order[jatos.studySessionData["taskindex"]]) });
      }

    }
  });
  const isMobile = /Mobi|Android/i.test(navigator.userAgent);
  const isTablet = window.innerWidth >= 600 && window.innerWidth <= 1024 && !isMobile;
  const smallScreen = window.innerHeight <= 800 && window.innerWidth <= 1440 && !isMobile && !isTablet;
  const canvasWidth = isMobile ? window.innerWidth * 0.9 : window.innerWidth * .9;
  const canvasHeight = isMobile ? window.innerHeight * 0.7 : smallScreen ? window.innerHeight * 0.8 : window.innerHeight * .65;
  const fontScale = isMobile ? 1.5 : 1.0;
  const stimScale = isMobile ? 0.9 : smallScreen ? 0.85: isTablet ? 0.8 : 0.9;
  document.body.classList.add(isMobile ? 'mobile' : 'desktop');
  if (smallScreen) {document.body.classList.add('smallScreen');}
  if (isTablet) {document.body.classList.add('tablet');}
  //var sid=getID()
  //console.log('In id, sid= ' + sid);
  let date = new Date(); 
  jsPsych.data.addProperties({
       //subject: sid,
       task: 'getid',
       date: date.toLocaleDateString()
       //urlid: jatos.urlQueryParameters.sid,
  });

  var idform = {
    type: jsPsychSurveyHtmlForm,
    preamble: function() {  
      return `<p class="prompt_text">Enter your ID code</p>`;
    },
    html: `
      <div style="display:flex; justify-content:center; align-items:center; font-size:32px; line-height:110%; gap:10px;">
        <p class="prompt_text idcode_text" style="margin:0;"><b>ID:</b></p>
        <input class="idcode" name="idcode" type="text" required/>
      </div>
    `,
    on_load: function() {
      // hide default button
      document.querySelector('.jspsych-btn').style.display = 'none';

      // insert your custom button
      document.querySelector('.jspsych-content').insertAdjacentHTML('beforeend', `
        <div class="image-btn-wrapper">
          <input type="image" src="img/assets/blank_green.png"
                class="image-btn" id="id_continue_btn">
          <svg class="image-btn-text" viewBox="0 0 266 160">
            <text x="50%" y="50%">Continue</text>
          </svg>
        </div>
      `);

      const customBtn = document.getElementById('id_continue_btn');
      customBtn.addEventListener('click', (e) => {
        e.preventDefault(); // prevent default image-button form submit weirdness
        document.querySelector('.jspsych-btn').click();
      });

      // press/release stuff
      document.addEventListener('mouseover', handlePress, true);
      document.addEventListener('mouseleave', handleRelease, true);
      document.addEventListener('touchstart', handlePress, { passive: true });
      document.addEventListener('touchend', handleRelease);
      document.addEventListener('mouseup', handleRelease);
    },

    on_finish: function(data) {
      // clean up listeners
      document.removeEventListener('mouseover', handlePress, true);
      document.removeEventListener('mouseleave', handleRelease, true);
      document.removeEventListener('touchstart', handlePress);
      document.removeEventListener('touchend', handleRelease);
      document.removeEventListener('mouseup', handleRelease);

      console.log(data.response);
      var sid = data.response['idcode'];
      console.log(sid);
      jatos.studySessionData['sid'] = sid;
    }
  };
  
  let activeBtn = null;

  function handlePress(e) {
    const wrapper = e.target.closest('.image-btn-wrapper');
    if (!wrapper) return;

    const btn = wrapper.querySelector('.image-btn');
    const origSrc = btn.dataset.orig || btn.src;
    const pressedSrc = btn.dataset.pressed || origSrc.replace('.png', '_pressed.png');

    btn.dataset.orig = origSrc;
    btn.dataset.pressed = pressedSrc;

    btn.src = pressedSrc;
    wrapper.classList.add('pressed');

    activeBtn = btn;  // remember which button is pressed
  }

  function handleRelease(e) {
    if (!activeBtn) {
      return; // nothing to release
    }
    const wrapper = activeBtn.closest('.image-btn-wrapper');
    activeBtn.src = activeBtn.dataset.orig;
    wrapper.classList.remove('pressed');

    activeBtn = null; // reset
  }

  var timeline=[idform];
  jsPsych.run(timeline);

});
</script>

</html>
