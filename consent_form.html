<!doctype html>
<html>
<!-- 
11/30/2020: Updated batch session logging to create a single array per subject with a chronological list of each time
6/19/2410/23/23 (CELS): Multi-lang support using Honeycomb style language file

-->
<head>
  <link rel="stylesheet" href="css/consent_form.css" />
  <script type="text/javascript" src="jatos.js"></script>
  <script src="js/jquery-3.1.1.min.js"></script>
  <meta charset="UTF-8" />
  <title>Consent Form</title>
</head>
<style>
  body {
    background-color: #fff9e0;
  }
  /* Slightly shorter special buttons for laptop-size screens */
  @media screen and (min-width: 1100px) and (max-width: 1400px) {
    #button-container .jspsych-btn {
      height: 2.4em !important; /* down from 3em */
    }
  }

  /* For short screens (e.g. 632px tall) */
  @media screen and (max-height: 700px) {
    #button-container .jspsych-btn {
      height: 2.2em !important;
    }
  }
  .image-btn-wrapper {
    display: inline-block;
    position: relative;
    margin: 0.5em;
  }

  .desktop .image-btn-wrapper:hover .image-btn-text {
    transform: translate(-50%, -40%); /* lower by 10% */
  }

  .image-btn {
    width: 20em;
    height: auto;
    border: none;
    display: block;
  }

  .mobile .image-btn {
    width: 25em;
    height: auto;
    border: none;
    display: block;
  }

  .smallScreen .image-btn {
    width: 15em;
    height: auto;
    border: none;
    display: block;
  }

  .image-btn-text {
    position: absolute;
    top: 38%;
    left: 50%;
    transform: translate(-50%, -50%);
    font-family: "Comic Sans MS", "Comic Neue", cursive;
    font-size: 1.5em;
    color: #fff8d6;
    font-weight: bold;
    -webkit-text-stroke: 10px #5d2b12;
    stroke-linejoin: round;
    paint-order: stroke fill;
    pointer-events: none;
    letter-spacing: 0.08em;

  }

  .image-btn-text.cn {
    font-size: 2.5em;
  }

  .image-btn-text.es {
    font-size: 2.0em;
  }

  .image-btn-text.kr{
    font-size: 1.85em;
  }

  .image-btn-text.ru{
    font-size: 1.85em;
    -webkit-text-stroke: 8px #5d2b12;
  }

  .image-btn-text.nl{
    font-size: 0.8em;
  }

  .mobile .image-btn-text {
    -webkit-text-stroke: 16px #5d2b12;
    paint-order: stroke fill;
    font-size: 2.4em;
  }

  .mobile .image-btn-text.cn{
    font-size: 3em;
  }

  .mobile .image-btn-text.nl{
    font-size: 2.4em;
  }

  .mobile .image-btn-text.kr{
    font-size: 2.4em;
    -webkit-text-stroke: 14px #5d2b12;
  }

  .mobile .image-btn-text.ru {
    -webkit-text-stroke: 14px #5d2b12;
    font-size: 2.5em;
  }

  .mobile .image-btn-text.es {
    font-size: 2.8em;
  }
  
  .smallScreen .image-btn-text {
    -webkit-text-stroke: 7px #5d2b12;
    paint-order: stroke fill;
    font-size: 1.4em;
  }

  .smallScreen .image-btn-text.kr{
    -webkit-text-stroke: 8px #5d2b12;
    paint-order: stroke fill;
    font-size: 0.8em;
  }

  .smallScreen .image-btn-text.nl{
    -webkit-text-stroke: 6px #5d2b12;
    paint-order: stroke fill;
    font-size: 0.6em;
  }

  .smallScreen .image-btn-text.ru{
    -webkit-text-stroke: 7px #5d2b12;
    paint-order: stroke fill;
    font-size: 1.75em;
  }

  .smallScreen .image-btn-text.cn{
    -webkit-text-stroke: 7px #5d2b12;
    paint-order: stroke fill;
    font-size: 1.75em;
  }

  .prompt_text {
    font-family: "Comic Sans MS", "Comic Neue", cursive;
    font-size: 2em;
    color: #5d2b12;
    font-weight: normal;
    line-height: 1.2;
  }

  .mobile  .prompt_text {
    font-size: 2em;
  }

  .mobile  .prompt_text.ru,
  .mobile  .prompt_text.nl,
  .mobile  .prompt_text.es {
    font-size: 1.8em;
  }

  .smallScreen  .prompt_text {
    font-size: 1.3em;
  }

  .smallScreen  .prompt_text.ru,
  .smallScreen  .prompt_text.nl {
    font-size: 1em;
  }

  #jspsych-html-button-response-stimulus {
    font-family: "Comic Sans MS", "Comic Neue", cursive;
    font-size: 1.5em;
    color: #5d2b12;
    line-height: 1.2;
  }
  
  .jspsych-categorize-image-buttons-stimulus {
    width: 15em;
    height: auto;
  }

  .mobile .jspsych-categorize-image-buttons-stimulus {
    width: 25em;
    height: auto;
  }

  .smallScreen .jspsych-categorize-image-buttons-stimulus {
    width: 10em;
    height: auto;
  }
</style>

<body>

<script type="text/javascript">
function getID() {
  // Try to get a reasonable ID code for this person
  // URL > studySession > workerID
  var sid = jatos.urlQueryParameters.sid;
  if (sid == undefined) {
    sid = jatos.studySessionData['sid'];
  }
  if (typeof sid == 'undefined') {
    if (typeof jatos.workerId !== 'undefined') { // At least try the workerID 
      sid = jatos.workerId;
    }
    else { sid = 1234; }
  }
  return sid
}
function waitFor(conditionFunction) {
  const poll = resolve => {
  if(conditionFunction()) resolve();
    else setTimeout(_ => poll(resolve), 400);
  }
  return new Promise(poll)
}
const isMobile = /Mobi|Android/i.test(navigator.userAgent);
const smallScreen = window.innerHeight <= 800 && window.innerWidth <= 1440 && !isMobile;
const canvasWidth = isMobile ? window.innerWidth * 0.9 : window.innerWidth * .9;
const canvasHeight = isMobile ? window.innerHeight * 0.7 : smallScreen ? window.innerHeight * 0.8 : window.innerHeight * .50;
const fontScale = isMobile ? 1.5 : 1.0;
const stimScale = isMobile ? 2 : smallScreen ? 0.85: 1.0;
document.body.classList.add(isMobile ? 'mobile' : 'desktop');
if (smallScreen) {document.body.classList.add('smallScreen');}
jatos.onLoad(async function () {
  var sid = getID();
  console.log('In consent, sid= ' + sid);

  let date = new Date();
  let dcode = date.getFullYear() + "-" + (date.getMonth() + 1) + "-" + (date.getDate()) +
              "-" + date.getHours() + "-" + date.getMinutes();

  // Batch session tracking
  if (!jatos.batchSession.defined("/" + sid)) {
    jatos.batchSession.add("/" + sid, ["ConsentLoad_" + dcode]);
  } else {
    jatos.batchSession.add("/" + sid + "/-", "ConsentLoad_" + dcode);
  }

  // Determine language
  var lang='en';
  if (typeof jatos.studySessionData['lang'] !== 'undefined') lang=jatos.studySessionData['lang'];
  if (jatos.studyJsonInput && typeof jatos.studyJsonInput['lang'] !== 'undefined') lang=jatos.studyJsonInput['lang'];
  if (jatos.batchJsonInput && typeof jatos.batchJsonInput['lang'] !== 'undefined') lang=jatos.batchJsonInput['lang'];

  // Load language JSON
  var langfile='lang/omst_'+lang+'.json';
  var json_prompts=null;
  $.getJSON(langfile,function(data) { json_prompts=data; });
  await waitFor(_ => json_prompts !== null);
  let prompts=json_prompts['consent'];

  // Build consent text HTML (keep original formatting)
  let container = document.createElement("div");
  container.innerHTML = `
    <div id="consenttext">
      <h1>${prompts['title']}</h1>
      ${prompts['study']['uni']}
      ${prompts['study']['sis']}
      ${prompts['study']['num']}
      <br>
      ${prompts['researcher']['title']}
      ${prompts['researcher']['name']}
      ${prompts['researcher']['dept']}
      ${prompts['researcher']['tele']}
      ${prompts['researcher']['email']}
      <ul>${prompts['text']}${prompts['prompt']}</ul>
    </div>
  `;
  document.body.appendChild(container);

  // Build buttons as image buttons
  var buttonsDiv = document.createElement('div');
  buttonsDiv.id = 'buttons';
  buttonsDiv.style.display = 'flex';
  buttonsDiv.style.justifyContent = 'center'; // aligns with consent text
  buttonsDiv.style.gap = '40px';
  buttonsDiv.style.marginTop = '20px';
  buttonsDiv.innerHTML = `
    <div id="agreeButtonWrapper" class="image-btn-wrapper">
      <input type="image" src="img/assets/blank_green.png"
             onmouseover="this.src='img/assets/blank_green_pressed.png'"
             onmouseout="this.src='img/assets/blank_green.png'"
             class="image-btn">
      <span class="image-btn-text ${lang}">${prompts['buttons']['agree']}</span>
    </div>

    <div id="cancelButtonWrapper" class="image-btn-wrapper">
      <input type="image" src="img/assets/blank_red.png"
             onmouseover="this.src='img/assets/blank_red_pressed.png'"
             onmouseout="this.src='img/assets/blank_red.png'"
             class="image-btn">
      <span class="image-btn-text ${lang}">${prompts['buttons']['cancel']}</span>
    </div>
  `;
  document.getElementById('consenttext').after(buttonsDiv);

  // Agree button click
  document.getElementById('agreeButtonWrapper').addEventListener('click', function() {
    let date = new Date();
    let dcode = date.getFullYear() + "-" + (date.getMonth() + 1) + "-" + (date.getDate()) +
                "-" + date.getHours() + "-" + date.getMinutes();
    jatos.batchSession.add("/" + sid + "/-", "ConsentAgreed_" + dcode);
    var expdata = "Consent given, ID=" + sid + " URL ID=" + jatos.urlQueryParameters.sid;

    var order=jatos.studySessionData["order"];
    jatos.studySessionData["taskindex"] += 1;

    if (typeof order === 'undefined' || order.length == jatos.studySessionData["taskindex"]) {
      if (typeof jatos.urlQueryParameters.sid === 'undefined' ||
          typeof jatos.urlQueryParameters.sona === 'undefined' ||
          typeof jatos.studyJsonInput['experiment_id'] === 'undefined' ||
          typeof jatos.studyJsonInput['credit_token'] === 'undefined') {
        jatos.submitResultData(expdata,jatos.endStudy);
      } else {
        var redirect='https://uci.sona-systems.com/webstudy_credit.aspx?experiment_id='+jatos.studyJsonInput['experiment_id']+
                     '&credit_token='+jatos.studyJsonInput['credit_token']+'&survey_code='+jatos.urlQueryParameters.sid;
        jatos.endStudyAndRedirect(redirect,expdata);
      }
    } else {
      jatos.submitResultData(expdata, () => { jatos.startComponentByPos(order[jatos.studySessionData["taskindex"]]) });
    }
  });

  // Cancel button click
  document.getElementById('cancelButtonWrapper').addEventListener('click', function() {
    let date = new Date();
    let dcode = date.getFullYear() + "-" + (date.getMonth() + 1) + "-" + (date.getDate()) +
                "-" + date.getHours() + "-" + date.getMinutes();
    jatos.batchSession.add("/" + sid + "/-", "ConsentNOTAgreed_" + dcode);
    jatos.abortStudy("Consent not given.");
  });
});




</script>
</body>

</html>