<!doctype html>
<html>
<!-- 
11/30/2020: Updated batch session logging to create a single array per subject with a chronological list of each time
6/19/2410/23/23 (CELS): Multi-lang support using Honeycomb style language file

-->
<head>
  <link rel="stylesheet" href="css/consent_form.css" />
  <script type="text/javascript" src="jatos.js"></script>
  <script src="js/jquery-3.1.1.min.js"></script>
  <meta charset="UTF-8" />
  <title>Consent Form</title>
</head>
<style>
  .jspsych-display-element {
    font-size: 200%;
  }
  .jspsych-btn {
    font-size: 150%;
  }

  .image-btn-wrapper {
    display: inline-block;
    position: relative;
    margin: 0.5em;
  }

  .image-btn {
    width: 15vw;
    height: auto;
    border: none;
    display: block;
  }

  .smallScreen .image-btn {
    width: 20vw !important;
  }

  .mobile .image-btn {
    width: 35vw;
  }

  .tablet .image-btn {
    width: 25vw;
  }

  .image-btn-text {
    position: absolute;
    top: 38%;
    left: 50%;
    transform: translate(-50%, -50%);
    pointer-events: none;
    width: 100%;
    height: auto; /* scales with wrapper if you want */
  }

  .image-btn-text text {
    font-family: 'Comic Relief', sans-serif;
    font-size: 2.0em;
    fill: #fff8d6;       /* inner text color */
    stroke: #5d2b12;     /* outline color */
    stroke-width: 10;     /* outline thickness */
    font-weight: bold;
    letter-spacing: 0.08em;
    text-anchor: middle;
    dominant-baseline: middle;
    paint-order: stroke fill;
    stroke-linejoin: round;
    stroke-linecap: round;
  }
  
  .image-btn-wrapper.pressed .image-btn-text{
    transform: translate(-50%, -40%) !important;
  }

  .mobile .image-btn-text text{
    stroke-width: 14;
    font-size: 2.5em;
  }

  .image-btn-text.kr text,
  .image-btn-text.ru text{
    font-size: 2em;
    stroke-width: 10;
  }

  .image-btn-text.nl  text{
    font-size: 2em;
    stroke-width: 10;
  }
  
  .mobile .image-btn-text.kr text {
    font-size: 2em;
    stroke-width: 12;
  }

  .mobile .image-btn-text.nl text {
    font-size: 0.8em;
    stroke-width: 8;
  }

  .mobile .image-btn-text.ru text {
    font-size: 2.0em;
    stroke-width: 12;
  }
  
  .tablet .image-btn-text.kr text {
    font-size: 2.0em;
    stroke-width: 10;
  }

  .tablet .image-btn-text.ru text {
    font-size: 2.0em;
    stroke-width: 10;
  }

  body {
    background-color: #fff9e0;
  }

  .prompt_text {
    font-family: 'Comic Relief', sans-serif;
    font-size: 2.6em;
    color: #5d2b12;
    font-weight: normal;
    line-height: 1.2;
  }

  .mobile  .prompt_text {
    font-size: 3em;
  }

  .mobile .prompt_text.nl {
    font-size: 1.8em;
  }

  .mobile .prompt_text.ru {
    font-size: 1.6em;
  }

  .tablet .prompt_text{
    font-size: 1.2em;
  }

  .smallScreen .prompt_text {
    font-size: 2.6em;
  }

  .tablet .prompt_text.intro {
    font-size: 2.6em;
  }

  .mobile .prompt_text.es.intro,
  .mobile .prompt_text.nl.intro {
    font-size: 1.8em;
  }

  .mobile .prompt_text.ru.intro {
    font-size: 1.8em;
  }

  .smallScreen .prompt_text.ru.intro {
    font-size: 0.9em;
  }

  .prompt_text {
    font-family: 'Comic Relief', sans-serif;
    font-size: 2em;
    color: #5d2b12;
    font-weight: normal;
    line-height: 1.2;
  }

  .mobile  .prompt_text {
    font-size: 2em;
  }

  .mobile  .prompt_text.ru,
  .mobile  .prompt_text.nl,
  .mobile  .prompt_text.es {
    font-size: 1.8em;
  }

  .smallScreen  .prompt_text {
    font-size: 1.3em;
  }

  .smallScreen  .prompt_text.ru,
  .smallScreen  .prompt_text.nl {
    font-size: 1em;
  }

  #jspsych-html-button-response-stimulus {
    font-family: 'Comic Relief', sans-serif;
    font-size: 1.5em;
    color: #5d2b12;
    line-height: 1.2;
  }

  .tablet #consenttext {
    font-size: 1.8em;
  }
</style>

<body>

<script type="text/javascript">
function getID() {
  // Try to get a reasonable ID code for this person
  // URL > studySession > workerID
  var sid = jatos.urlQueryParameters.sid;
  if (sid == undefined) {
    sid = jatos.studySessionData['sid'];
  }
  if (typeof sid == 'undefined') {
    if (typeof jatos.workerId !== 'undefined') { // At least try the workerID 
      sid = jatos.workerId;
    }
    else { sid = 1234; }
  }
  return sid
}
function waitFor(conditionFunction) {
  const poll = resolve => {
  if(conditionFunction()) resolve();
    else setTimeout(_ => poll(resolve), 400);
  }
  return new Promise(poll)
}
const isMobile = /Mobi|Android/i.test(navigator.userAgent);
const isTablet = window.innerWidth >= 600 && window.innerWidth <= 1024 && !isMobile;
const smallScreen = window.innerHeight <= 800 && window.innerWidth <= 1440 && !isMobile && !isTablet;
const canvasWidth = isMobile ? window.innerWidth * 0.9 : window.innerWidth * .9;
const canvasHeight = isMobile ? window.innerHeight * 0.7 : smallScreen ? window.innerHeight * 0.8 : window.innerHeight * .65;
const fontScale = isMobile ? 1.5 : 1.0;
const stimScale = isMobile ? 0.9 : smallScreen ? 0.85: isTablet ? 0.8 : 0.9;
document.body.classList.add(isMobile ? 'mobile' : 'desktop');
if (smallScreen) {document.body.classList.add('smallScreen');}
if (isTablet) {document.body.classList.add('tablet');}

jatos.onLoad(async function () {
  var sid = getID();
  console.log('In consent, sid= ' + sid);

  let date = new Date();
  let dcode = date.getFullYear() + "-" + (date.getMonth() + 1) + "-" + (date.getDate()) +
              "-" + date.getHours() + "-" + date.getMinutes();

  // Batch session tracking
  if (!jatos.batchSession.defined("/" + sid)) {
    jatos.batchSession.add("/" + sid, ["ConsentLoad_" + dcode]);
  } else {
    jatos.batchSession.add("/" + sid + "/-", "ConsentLoad_" + dcode);
  }

  // Determine language
  var lang='en';
  if (typeof jatos.studySessionData['lang'] !== 'undefined') lang=jatos.studySessionData['lang'];
  if (jatos.studyJsonInput && typeof jatos.studyJsonInput['lang'] !== 'undefined') lang=jatos.studyJsonInput['lang'];
  if (jatos.batchJsonInput && typeof jatos.batchJsonInput['lang'] !== 'undefined') lang=jatos.batchJsonInput['lang'];

  // Load language JSON
  var langfile='lang/omst_'+lang+'.json';
  var json_prompts=null;
  $.getJSON(langfile,function(data) { json_prompts=data; });
  await waitFor(_ => json_prompts !== null);
  let prompts=json_prompts['consent'];

  // Build consent text HTML (keep original formatting)
  let container = document.createElement("div");
  container.innerHTML = `
    <div id="consenttext">
      <h1>${prompts['title']}</h1>
      ${prompts['study']['uni']}
      ${prompts['study']['sis']}
      ${prompts['study']['num']}
      <br>
      ${prompts['researcher']['title']}
      ${prompts['researcher']['name']}
      ${prompts['researcher']['dept']}
      ${prompts['researcher']['tele']}
      ${prompts['researcher']['email']}
      <ul>${prompts['text']}${prompts['prompt']}</ul>
    </div>
  `;
  document.body.appendChild(container);

  // Build buttons as image buttons
  var buttonsDiv = document.createElement('div');
  buttonsDiv.id = 'buttons';
  buttonsDiv.style.display = 'flex';
  buttonsDiv.style.justifyContent = 'center';
  buttonsDiv.style.gap = '40px';
  buttonsDiv.style.marginTop = '20px';
  buttonsDiv.innerHTML = `
    <div class="image-btn-wrapper" id="agreeButtonWrapper">
      <input type="image" src="img/assets/blank_green.png"
            class="image-btn">
      <svg class="image-btn-text ${lang}" viewBox="0 0 266 160">
        <text x="50%" y="50%">${prompts['buttons']['agree']}</text>
      </svg>
    </div>

    <div class="image-btn-wrapper" id="cancelButtonWrapper">
      <input type="image" src="img/assets/blank_red.png"
            class="image-btn">
      <svg class="image-btn-text ${lang}" viewBox="0 0 266 160">
        <text x="50%" y="50%">${prompts['buttons']['cancel']}</text>
      </svg>
    </div>
  `;
  document.body.appendChild(buttonsDiv);

  // ---------------------------------------------------------------------
  // Press / Release logic (works for both buttons)
  // ---------------------------------------------------------------------

  let activeBtn = null;

  function handlePress(e) {
    const wrapper = e.target.closest('.image-btn-wrapper');
    if (!wrapper) return;

    const btn = wrapper.querySelector('.image-btn');
    const origSrc = btn.dataset.orig || btn.src;
    const pressedSrc = btn.dataset.pressed || origSrc.replace('.png', '_pressed.png');

    btn.dataset.orig = origSrc;
    btn.dataset.pressed = pressedSrc;

    btn.src = pressedSrc;
    wrapper.classList.add('pressed');

    activeBtn = btn;
  }

  function handleRelease() {
    if (!activeBtn) return;

    const wrapper = activeBtn.closest('.image-btn-wrapper');
    activeBtn.src = activeBtn.dataset.orig;
    wrapper.classList.remove('pressed');
    activeBtn = null;
  }

  // Attach listeners to BOTH wrappers
  const wrappers = document.querySelectorAll('.image-btn-wrapper');
  wrappers.forEach(wrapper => {
    wrapper.addEventListener('mouseenter', handlePress, true);
    wrapper.addEventListener('mouseleave', handleRelease, true);
    wrapper.addEventListener('touchstart', handlePress, { passive: true });
    wrapper.addEventListener('touchend', handleRelease);
  });
  document.addEventListener('mouseup', handleRelease);

  // ---------------------------------------------------------------------
  // Click actions
  // ---------------------------------------------------------------------
  document.getElementById('agreeButtonWrapper').addEventListener('click', function() {
    // (your agree logic unchanged)
    let date = new Date();
    let dcode = date.getFullYear() + "-" + (date.getMonth() + 1) + "-" + date.getDate() +
                "-" + date.getHours() + "-" + date.getMinutes();
    jatos.batchSession.add("/" + sid + "/-", "ConsentAgreed_" + dcode);
    var expdata = "Consent given, ID=" + sid + " URL ID=" + jatos.urlQueryParameters.sid;

    var order=jatos.studySessionData["order"];
    jatos.studySessionData["taskindex"] += 1;

    if (!order || order.length == jatos.studySessionData["taskindex"]) {
      if (!jatos.urlQueryParameters.sid ||
          !jatos.urlQueryParameters.sona ||
          !jatos.studyJsonInput['experiment_id'] ||
          !jatos.studyJsonInput['credit_token']) {
        jatos.submitResultData(expdata,jatos.endStudy);
      } else {
        var redirect='https://uci.sona-systems.com/webstudy_credit.aspx?experiment_id='+jatos.studyJsonInput['experiment_id']+
                    '&credit_token='+jatos.studyJsonInput['credit_token']+'&survey_code='+jatos.urlQueryParameters.sid;
        jatos.endStudyAndRedirect(redirect,expdata);
      }
    } else {
      jatos.submitResultData(expdata, () =>
        jatos.startComponentByPos(order[jatos.studySessionData["taskindex"]])
      );
    }
  });

  document.getElementById('cancelButtonWrapper').addEventListener('click', function() {
    let date = new Date();
    let dcode = date.getFullYear() + "-" + (date.getMonth() + 1) + "-" + date.getDate() +
                "-" + date.getHours() + "-" + date.getMinutes();
    jatos.batchSession.add("/" + sid + "/-", "ConsentNOTAgreed_" + dcode);
    jatos.abortStudy("Consent not given.");
  });
});




</script>
</body>

</html>