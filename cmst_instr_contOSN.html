<!DOCTYPE html>
<html>
  <!--
  Task: Perceptual-baseline control task in cMST
  Author: Gavin Stark
  Forked from main cMST-Online on 11/20/19 and modified for mobile / Cordova
  Forked again on 8/20/20, pulled out Cordova, and setup for JATOS

Revised: November 20, 2019 (CELS) for Cordova
   11/22/19 (CELS) - cleanup parameter section
   11/25 (CELS): Button size increase
   12/4/19 (CELS): Using .replace not .href and will take you back to index.html if the end
   12/5/19 (CELS): Styles to alter text/button sizes, ensuring deviceready, meta-tag
   12/6/19 (CELS): Shifted data saving to savedata.js and setup to allow local backup save on iOS
   4/13/20 (CELS): Goes to end.html if this is the last phase
   4/16/20 (CELS): Will detect if on SONA and go back there for credit
   8/20/20 (CELS): Forked off and reworked for JATOS
   8/24/20 (CELS): Fixed jumping stimuli when using button response mode
   5/31/22 (CELS): Added bit about blank screen in main task
   10/21/22 (CELS): Updated default to buttons 
   2/28/23 (CELS): Updated to jsPsych7
   8/16/23 (CELS): Fixed for versions without setup.html to progress to next phase
   8/30/23 (CELS): Added getID() to come up with a good sid 
   10/23/23 (CELS): Multi-lang support using Honeycomb style language file
  
 Optional parameters:
  [sid=##]: Subject ID -- used for data file name (default=1234)
  [resp=X]: Response mode -- set to 'keyboard' to use keys, anything else to use buttons (default=button)
  [rand=#]: Should which stimuli are shown as repeats vs. lures be randomized? (default=0)
  [q_pcon=pagename]: Base of HTML filename to add into the queue after this task (default=null)

 -->

<head>
  <meta http-equiv="Content-Security-Policy" content="default-src 'self' data: gap:  'unsafe-inline' 'unsafe-eval' 
    https://fonts.gstatic.com http://www.stark-labs.com/exp/jsPsych/mobile_cMST/append_log.php http://www.stark-labs.com/exp/jsPsych/mobile_cMST/write_data_file.php; 
    style-src 'self' 'unsafe-inline' https://fonts.googleapis.com/css; media-src *; 
    img-src 'self' data: content:;">

  <script type="text/javascript" src="jatos.js"></script>
  <script type="text/javascript" src="js/index.js"></script>
  <script src="js/jquery-3.1.1.min.js"></script>
  <script src="js/jspsych_731/dist/jspsych.js"></script>
  <script src="js/jspsych_731/dist/plugin-html-keyboard-response.js"></script>
  <script src="js/jspsych_731/dist/plugin-html-button-response.js"></script>
  <script src="js/jspsych_731/dist/plugin-canvas-keyboard-response.js"></script>
  <script src="js/jspsych_731/dist/plugin-canvas-button-response.js"></script>
  <script src="js/jspsych_731/dist/plugin-categorize-image.js"></script>
  <script src="js/plugin-categorize-image-buttons.js"></script>
  <script src="js/jspsych_731/dist/plugin-preload.js"></script>
  <link rel="stylesheet" href="css/jspsych.css"></link>
  <style>
  .jspsych-display-element {
    font-size: 200%;
  }
  .jspsych-btn {
    font-size: 150%;
  }

  .image-btn-wrapper {
    display: inline-block;
    position: relative;
    margin: 0.5em;
  }

  .image-btn {
    width: 15vw;
    height: auto;
    border: none;
    display: block;
  }

  .smallScreen .image-btn {
    width: 15vw !important;
  }

  .mobile .image-btn {
    width: 35vw;
  }

  .tablet .image-btn {
    width: 25vw;
  }

  .image-btn-text {
    position: absolute;
    top: 38%;
    left: 50%;
    transform: translate(-50%, -50%);
    pointer-events: none;
    width: 100%;
    height: auto; /* scales with wrapper if you want */
  }

  .image-btn-text text {
    font-family: "Comic Sans MS", "Comic Sans", cursive;
    font-size: 1.5em;
    fill: #fff8d6;       /* inner text color */
    stroke: #5d2b12;     /* outline color */
    stroke-width: 10;     /* outline thickness */
    font-weight: bold;
    letter-spacing: 0.08em;
    text-anchor: middle;
    dominant-baseline: middle;
    paint-order: stroke fill;
    stroke-linejoin: round;
    stroke-linecap: round;
  }
  
  .image-btn-wrapper.pressed .image-btn-text{
    transform: translate(-50%, -40%) !important;
  }

  .mobile .image-btn-text text{
    stroke-width: 12;
    font-size: 1.5em;
  }

  .image-btn-text.kr text,
  .image-btn-text.ru text{
    font-size: 0.9em;
    stroke-width: 8;
  }

  .image-btn-text.nl  text{
    font-size: 0.9em;
    stroke-width: 10;
  }
  
  .mobile .image-btn-text.kr text,
  .mobile .image-btn-text.nl text{
    font-size: 0.9em;
    stroke-width: 9;
  }

  .mobile .image-btn-text.ru text{
    font-size: 1.2em;
    stroke-width: 12;
  }
  
  .tablet .image-btn-text.kr text {
    font-size: 1em;
    stroke-width: 8;
  }

  .tablet .image-btn-text.ru text{
    font-size: 1.2em;
    stroke-width: 10;
  }

  body {
    background-color: #fff9e0;
  }

  .prompt_text {
    font-family: "Comic Sans MS", "Comic Neue", cursive;
    font-size: 1.4em;
    color: #5d2b12;
    font-weight: normal;
    line-height: 1.2;
  }

  .mobile  .prompt_text {
    font-size: 2em;
  }

  .mobile .prompt_text.nl {
    font-size: 1.8em;
  }

  .mobile .prompt_text.ru {
    font-size: 1.6em;
  }

  .tablet .prompt_text{
    font-size: 1.2em;
  }

  .smallScreen .prompt_text {
    font-size: 1em;
  }

  .tablet .prompt_text.intro {
    font-size: 1.4em;
  }

  .mobile .prompt_text.es.intro,
  .mobile .prompt_text.nl.intro {
    font-size: 1.8em;
  }

  .mobile .prompt_text.ru.intro {
    font-size: 1.4em;
  }

  .smallScreen .prompt_text.ru.intro {
    font-size: 0.9em;
  }

  .jspsych-categorize-image-buttons-stimulus{
    width: 25vw;
    height: auto;
    display: block;
    margin: 0 auto;
  }

  .tablet .jspsych-categorize-image-buttons-stimulus {
    width: 65vw;
  }

  .mobile .jspsych-categorize-image-buttons-stimulus {
    width: 75vw;
  }

  .smallScreen .jspsych-categorize-image-buttons-stimulus{
    width: 30vw;
  }

  </style>
</head>
<script>


function waitFor(conditionFunction) {
  const poll = resolve => {
  if(conditionFunction()) resolve();
    else setTimeout(_ => poll(resolve), 400);
  }
  return new Promise(poll)
}

function getID() {
  // Try to get a reasonable ID code for this person.  You can use the URL with a "sid" parameter or
  // specify one in the jatos studySessionData. If not, it'll use the JATOS workerId.
  // URL > studySession > workerID
  var sid=jatos.urlQueryParameters.sid;
  if (sid == undefined) {
    sid=jatos.studySessionData['sid'];
  }
  if (typeof sid == 'undefined') {
    if (typeof jatos.workerId !== 'undefined') { // At least try the workerID
      sid = jatos.workerId;
    }
    else { sid=1234; }
  }
  return sid
}

jatos.onLoad(async function() {
  const phasename='cmst_instr_contOSN';
  var sid=getID();
  var resp_mode='button';
  if (jatos.studySessionData['resp_mode'] == 'keyboard') {
    resp_mode='key';
  }
  else if (jatos.studySessionData['resp_mode'] == 'key') {
    resp_mode='key';
  }

  var lang='en';
  if (typeof jatos.studySessionData['lang'] !== 'undefined') {
    lang=jatos.studySessionData['lang'];
  }
  if (jatos.studyJsonInput && typeof jatos.studyJsonInput['lang'] !== 'undefined' ) { 
    lang=jatos.studyJsonInput['lang']
  }
  if (jatos.batchJsonInput && typeof jatos.batchJsonInput['lang'] !== 'undefined' ) { 
    lang=jatos.batchJsonInput['lang']
  }

  // load honeycomb version of lang file
  console.log('loading json lang: ',lang)
  var langfile='lang/omst_'+lang+'.json';
  var json_prompts=null;
  $.getJSON(langfile,function( data ) {
    json_prompts=data;
    console.debug(langfile + ' loaded...ish');
  });
  await waitFor(_ => json_prompts !== null);
  console.log(json_prompts['task']['name'])
  let prompts=json_prompts['instructions']; // Load in this phase's section

  const preload_fnames = new Array(17);

  preload_fnames.push(
    "img/assets/blank_blue.png",
    "img/assets/blank_blue_pressed.png",
    "img/assets/blank_green.png",
    "img/assets/blank_green_pressed.png",
    "img/assets/blank_red.png",
    "img/assets/blank_red_pressed.png",
    'img/assets/foil_1032_border.png',
    'img/assets/foil_1033_border.png',
    'img/assets/pcon026a_border.png',
    'img/assets/pcon026b_border.png',
    'img/pcon026a.jpg',
    'img/pcon026b.jpg',
    'img/assets/foil_1035_border.png',
    'img/assets/pcon028a_border.png',
    'img/assets/pcon028b_border.png',
    'img/pcon028a.jpg',
    'img/pcon028b.jpg',
  );

  var jsPsych = initJsPsych({on_finish: function() {
      if (0) { jsPsych.data.displayData(); }
      else {
        var order=jatos.studySessionData["order"];
        jatos.studySessionData["taskindex"] += 1;
        if (typeof order === 'undefined') {
          // We don't have an 'order' setup, so assume it's 1-N
          console.log('faking an order')
          order=Array(jatos.componentList.length).fill().map((e,i)=>i+1);
          jatos.studySessionData["taskindex"]=jatos.componentPos;
          //console.log(order);
          //console.log(jatos.studySessionData["taskindex"]);
        }
        var expdata = jsPsych.data.get().json();
        // Submit results to JATOS and queue the end or next task
        if (typeof order === 'undefined' || order.length == jatos.studySessionData["taskindex"]) { 
          // we're done
          // Check if this came from SONA - should have URL.sid and .sona
          if (typeof jatos.urlQueryParameters.sid === 'undefined' || typeof jatos.urlQueryParameters.sona === 'undefined' ||
              typeof jatos.studyJsonInput['experiment_id'] === 'undefined' || typeof jatos.studyJsonInput['credit_token'] === 'undefined') {
            jatos.submitResultData(expdata,jatos.endStudy);
          }
          else {
            var redirect='https://uci.sona-systems.com/webstudy_credit.aspx?experiment_id='+jatos.studyJsonInput['experiment_id']+
              '&credit_token='+jatos.studyJsonInput['credit_token']+'&survey_code='+jatos.urlQueryParameters.sid;
            jatos.endStudyAndRedirect(redirect,expdata);
          }
        }
        else {
          // submit and start the next
          jatos.submitResultData(expdata, () => { jatos.startComponentByPos(order[jatos.studySessionData["taskindex"]]) });
        }
      }
    }
  });
  const isMobile = /Mobi|Android/i.test(navigator.userAgent);
  const isTablet = window.innerWidth >= 600 && window.innerWidth <= 1024 && !isMobile;
  const smallScreen = window.innerHeight <= 800 && window.innerWidth <= 1440 && !isMobile && !isTablet;
  const canvasWidth = isMobile ? window.innerWidth * 0.9 : window.innerWidth * .9;
  const canvasHeight = isMobile ? window.innerHeight * 0.7 : smallScreen ? window.innerHeight * 0.8 : window.innerHeight * .65;
  const fontScale = isMobile ? 1.5 : 1.0;
  const stimScale = isMobile ? 0.9 : smallScreen ? 0.85: isTablet ? 0.8 : 0.9;
  document.body.classList.add(isMobile ? 'mobile' : 'desktop');
  if (smallScreen) {document.body.classList.add('smallScreen');}
  if (isTablet) {document.body.classList.add('tablet');}
  jsPsych.data.addProperties({
    task: phasename,
    subject: sid,
  });

  function roundRect(ctx, x, y, w, h, r) {
    ctx.beginPath();
    ctx.moveTo(x + r, y);
    ctx.lineTo(x + w - r, y);
    ctx.quadraticCurveTo(x + w, y, x + w, y + r);
    ctx.lineTo(x + w, y + h - r);
    ctx.quadraticCurveTo(x + w, y + h, x + w - r, y + h);
    ctx.lineTo(x + r, y + h);
    ctx.quadraticCurveTo(x, y + h, x, y + h - r);
    ctx.lineTo(x, y + r);
    ctx.quadraticCurveTo(x, y, x + r, y);
    ctx.closePath();
  }

  let activeBtn = null;

  function handlePress(e) {
    const wrapper = e.target.closest('.image-btn-wrapper');
    if (!wrapper) return;

    const btn = wrapper.querySelector('.image-btn');
    const origSrc = btn.dataset.orig || btn.src;
    const pressedSrc = btn.dataset.pressed || origSrc.replace('.png', '_pressed.png');

    btn.dataset.orig = origSrc;
    btn.dataset.pressed = pressedSrc;

    btn.src = pressedSrc;
    wrapper.classList.add('pressed');

    activeBtn = btn;  // remember which button is pressed
  }

  function handleRelease(e) {
    if (!activeBtn) {
      return; // nothing to release
    }
    const wrapper = activeBtn.closest('.image-btn-wrapper');
    activeBtn.src = activeBtn.dataset.orig;
    wrapper.classList.remove('pressed');

    activeBtn = null; // reset
  }

  //var trial_choices= prompts['k_trial_choices'];  // DELETE THIS

  // Default is keyboard here - override if buttons
  //var instr_choice=[' ']; // 32 is space
  //var instr_txt='<i>spacebar</i>'; //
  //var trial_type='';
  //var trial_txt=prompts['k_trial_text']; //
  //var trial_choices=['v','b','n']; //
  var extra_html='';
  if (resp_mode == 'button') {
    //instr_choice=['OK']; //
    //instr_txt='<i>OK</i>'; //
    //trial_type='-buttons';
    //trial_txt='<i>Old</i>, <i>Similar</i>, or <i>New</i>'; //
    //trial_choices=['Old','Similar','New']; //
    extra_html='style="margin-top:112px;"';
    extra_html='';
  }

  //console.log(prompts['k_trial_choices'][0], prompts['k_trial_choices'][1], prompts['k_trial_choices'][2])


function makeCategorizeTrial(imgPath, keyAnswer, buttonAnswer, promptText, incText, corText) {
  const maxPromptHeight = 80;
  const trial_choices = isMobile ?
    [prompts[resp_mode]['trial_choices']['old'], 
     prompts[resp_mode]['trial_choices']['new'], 
     prompts[resp_mode]['trial_choices']['sim']]
    :
    [prompts[resp_mode]['trial_choices']['old'], 
     prompts[resp_mode]['trial_choices']['sim'], 
     prompts[resp_mode]['trial_choices']['new']];

  return {
    type: (resp_mode == 'button' ? jsPsychCategorizeImageButtons : jsPsychCategorizeImage),
    stimulus: imgPath,
    key_answer: keyAnswer,
    button_answer: buttonAnswer,
    choices: trial_choices,
    prompt: `
      <div class="prompt-container" style="height: ${maxPromptHeight}px;">
        <p class="prompt prompt_text ${lang}" style="font-weight: normal;">${promptText}</p>
      </div>
    `,
    incorrect_text: `
      <div class="prompt-container" style="height: ${maxPromptHeight}px;">
        <p class="prompt prompt_text ${lang}" style="font-weight: normal;color: red;">${incText}</p>
      </div>
    `,
    correct_text: `
      <div class="prompt-container" style="height: ${maxPromptHeight}px;">
        <p class="prompt prompt_text ${lang}" style="font-weight: normal;color: green;">${corText}</p>
      </div>
    `,
    force_correct_button_press: true,
    button_html: trial_choices.map((txt, i) => `
      <div class="image-btn-wrapper">
        <input type="image" 
               src="img/assets/blank_${isMobile ? ['red','blue','green'][i] : ['red','green','blue'][i]}.png"
               class="image-btn">
        <svg class="image-btn-text ${lang}" viewBox="0 0 266 160">
          <text x="50%" y="50%">${txt}</text>
        </svg>
      </div>
    `),
    on_load: function() {
      document.addEventListener('mouseover', handlePress, true);
      document.addEventListener('mouseleave', handleRelease, true);
      document.addEventListener('touchstart', handlePress, { passive: true });
      document.addEventListener('touchend', handleRelease);

      document.addEventListener('mouseup', handleRelease);
    },

    on_finish: function() {
      document.removeEventListener('mouseover', handlePress, true);
      document.removeEventListener('mouseleave', handleRelease, true);
      document.removeEventListener('touchstart', handlePress);
      document.removeEventListener('touchend', handleRelease);

      document.removeEventListener('mouseup', handleRelease);
    },
  };
}

function makeSideBySideTrial(imgLeft, imgRight, promptText, buttonLabel) {
  return {
    type: (resp_mode == 'button' ? jsPsychCanvasButtonResponse : jsPsychCanvasKeyboardResponse),
    choices: [buttonLabel],
    canvas_size: isMobile ? [canvasHeight * 0.6, canvasWidth] : smallScreen ? [canvasHeight * 0.8, canvasWidth] : isTablet ? [canvasHeight * 0.6, canvasWidth] : [canvasHeight * 0.8, canvasWidth],
    stimulus: function(c) {
      const ctx = c.getContext('2d');
      ctx.fillStyle = '#fff9e0';
      const gap = 60; // spacing between the two images
      const framePadding = 20;
      const radius = 25;
      const width = c.width;
      const height = c.height;
      ctx.fillRect(0, 0, width, height);



      const imgL = new Image();
      const imgR = new Image();

      imgL.onload = imgR.onload = function() {
        const imgWidth = imgL.width * stimScale;
        const imgHeight = imgL.height * stimScale;
        const totalWidth = imgWidth * 2 + gap;
        const x = (c.width - totalWidth) / 2;
        const y = (c.height - imgHeight) / 2;

        // draw function for each image
        function drawFramedImage(img, x) {
          ctx.fillStyle = '#ffffff';
          ctx.strokeStyle = '#5d2514';
          ctx.lineWidth = 15;
          roundRect(ctx, x - framePadding, y - framePadding,
                  imgWidth + 2 * framePadding, imgHeight + 2 * framePadding, radius);
          ctx.fill();
          ctx.stroke();
          ctx.drawImage(img, x, y, imgWidth, imgHeight);
        }
        drawFramedImage(imgL, x);
        drawFramedImage(imgR, x + imgWidth + gap);
      };

      imgL.src = imgLeft;
      imgR.src = imgRight;
    },
    prompt: `<p class="prompt_text" style="margin: 0 0">${promptText}</p>`,
    button_html:           
      `<div class="image-btn-wrapper">
        <input type="image" src="img/assets/blank_green.png"
              class="image-btn">
        <svg class="image-btn-text" viewBox="0 0 266 160">
          <text x="50%" y="50%">${prompts[resp_mode]['instr_choice']}</text>
        </svg>
      </div>`,
    on_load: function() {
      document.addEventListener('mouseover', handlePress, true);
      document.addEventListener('mouseleave', handleRelease, true);
      document.addEventListener('touchstart', handlePress, { passive: true });
      document.addEventListener('touchend', handleRelease);

      document.addEventListener('mouseup', handleRelease);
    },

    on_finish: function() {
      document.removeEventListener('mouseover', handlePress, true);
      document.removeEventListener('mouseleave', handleRelease, true);
      document.removeEventListener('touchstart', handlePress);
      document.removeEventListener('touchend', handleRelease);

      document.removeEventListener('mouseup', handleRelease);
    },
  };
}

var intro = {
  type: (resp_mode == 'button' ? jsPsychHtmlButtonResponse : jsPsychHtmlKeyboardResponse),
  choices: [prompts[resp_mode]['instr_choice']],
  button_html:           
    `<div class="image-btn-wrapper">
      <input type="image" src="img/assets/blank_green.png"
            class="image-btn">
      <svg class="image-btn-text" viewBox="0 0 266 160">
        <text x="50%" y="50%">${prompts[resp_mode]['instr_choice']}</text>
      </svg>
    </div>`,
  on_load: function() {
    document.addEventListener('mouseover', handlePress, true);
    document.addEventListener('mouseleave', handleRelease, true);
    document.addEventListener('touchstart', handlePress, { passive: true });
    document.addEventListener('touchend', handleRelease);

    document.addEventListener('mouseup', handleRelease);
  },

  on_finish: function() {
    document.removeEventListener('mouseover', handlePress, true);
    document.removeEventListener('mouseleave', handleRelease, true);
    document.removeEventListener('touchstart', handlePress);
    document.removeEventListener('touchend', handleRelease);

    document.removeEventListener('mouseup', handleRelease);
  },
  prompt: `<p class="prompt_text">${prompts[resp_mode]['prompt0']}</p>`,
  stimulus: `<p class="prompt_text intro ${lang}">` + prompts['txt0'] + '</p>',
}

var new1 = isMobile ?
  makeCategorizeTrial(
    'img/assets/foil_1032_border.png',
    prompts['key']['trial_choices']['new'],
    1,
    prompts[resp_mode]['prompt_new'],
    prompts[resp_mode]['inc_new'],
    prompts['cor_new']
  ) 
  :
  makeCategorizeTrial(
    'img/assets/foil_1032_border.png',
    prompts['key']['trial_choices']['new'],
    2,
    prompts[resp_mode]['prompt_new'],
    prompts[resp_mode]['inc_new'],
    prompts['cor_new']
  )

var new2 = isMobile ?
  makeCategorizeTrial(
    'img/assets/foil_1033_border.png',
    prompts['key']['trial_choices']['new'],
    1,
    prompts[resp_mode]['prompt_new'],
    prompts[resp_mode]['inc_new'],
    prompts['cor_new']
  )
  :
  makeCategorizeTrial(
    'img/assets/foil_1033_border.png',
    prompts['key']['trial_choices']['new'],
    2,
    prompts[resp_mode]['prompt_new'],
    prompts[resp_mode]['inc_new'],
    prompts['cor_new']
  );

var new3 = isMobile ?
  makeCategorizeTrial(
    'img/assets/pcon026a_border.png',
    prompts['key']['trial_choices']['new'],
    1,
    prompts[resp_mode]['prompt_new'],
    prompts[resp_mode]['inc_new'],
    prompts['cor_new']
  )  
  :
  makeCategorizeTrial(
    'img/assets/pcon026a_border.png',
    prompts['key']['trial_choices']['new'],
    2,
    prompts[resp_mode]['prompt_new'],
    prompts[resp_mode]['inc_new'],
    prompts['cor_new']
  );

var repeat1 = makeCategorizeTrial(
  'img/assets/foil_1033_border.png',
  prompts['key']['trial_choices']['old'],
  0,
  prompts[resp_mode]['prompt_rep'],
  prompts[resp_mode]['inc_rep'],
  prompts['cor_rep']
);

var lure1 = isMobile ?
  makeCategorizeTrial(
    'img/assets/pcon026b_border.png',
    prompts['key']['trial_choices']['sim'],
    2,
    prompts[resp_mode]['prompt_lure'],
    prompts[resp_mode]['inc_lure'],
    prompts['cor_lure']
  )
  :
  makeCategorizeTrial(
    'img/assets/pcon026b_border.png',
    prompts['key']['trial_choices']['sim'],
    1,
    prompts[resp_mode]['prompt_lure'],
    prompts[resp_mode]['inc_lure'],
    prompts['cor_lure']
  );

var side_by_side1 = makeSideBySideTrial(
  'img/pcon026a.jpg',
  'img/pcon026b.jpg',
  prompts['side_by_side'],
  prompts[resp_mode]['instr_choice']
);

var new4 = isMobile ?
  makeCategorizeTrial(
    'img/assets/foil_1035_border.png',
    prompts['key']['trial_choices']['new'],
    1,
    prompts['prompt_test'] + ' ' + prompts[resp_mode]['trial_txt'],
    prompts[resp_mode]['inc_new'],
    prompts['cor_new']
  )
  :
  makeCategorizeTrial(
    'img/assets/foil_1035_border.png',
    prompts['key']['trial_choices']['new'],
    2,
    prompts['prompt_test'] + ' ' + prompts[resp_mode]['trial_txt'],
    prompts[resp_mode]['inc_new'],
    prompts['cor_new']
  );

var new5 = isMobile ?
  makeCategorizeTrial(
    'img/assets/pcon028a_border.png',
    prompts['key']['trial_choices']['new'],
    1,
    prompts['prompt_test'] + ' ' + prompts[resp_mode]['trial_txt'],
    prompts[resp_mode]['inc_new'],
    prompts['cor_new']
  )
  :
  makeCategorizeTrial(
    'img/assets/pcon028a_border.png',
    prompts['key']['trial_choices']['new'],
    2,
    prompts['prompt_test'] + ' ' + prompts[resp_mode]['trial_txt'],
    prompts[resp_mode]['inc_new'],
    prompts['cor_new']
  );

var repeat2 = makeCategorizeTrial(
  'img/assets/foil_1035_border.png',
  prompts['key']['trial_choices']['old'],
  0,
  prompts['prompt_test'] + ' ' + prompts[resp_mode]['trial_txt'],
  prompts[resp_mode]['inc_rep'],
  prompts['cor_rep']
);

var lure2 = isMobile ?
  makeCategorizeTrial(
    'img/assets/pcon028b_border.png',
    prompts['key']['trial_choices']['sim'],
    2,
    prompts['prompt_test'] + ' ' + prompts[resp_mode]['trial_txt'],
    prompts[resp_mode]['inc_lure'],
    prompts['cor_lure']
  )
  :
  makeCategorizeTrial(
    'img/assets/pcon028b_border.png',
    prompts['key']['trial_choices']['sim'],
    1,
    prompts['prompt_test'] + ' ' + prompts[resp_mode]['trial_txt'],
    prompts[resp_mode]['inc_lure'],
    prompts['cor_lure']
  );

var side_by_side2 = makeSideBySideTrial(
  'img/pcon028a.jpg',
  'img/pcon028b.jpg',
  prompts['side_by_side'],
  prompts[resp_mode]['instr_choice']
);
var outtro = {
  type: (resp_mode == 'button' ? jsPsychHtmlButtonResponse : jsPsychHtmlKeyboardResponse),
  choices: [prompts[resp_mode]['instr_choice']],
  prompt: '<p class="prompt_text">' + prompts[resp_mode]['prompt0'] + '</p>',
  stimulus: `<p class="prompt_text intro">` + prompts['end'] + '</p>', 
  button_html:           
    `<div class="image-btn-wrapper">
      <input type="image" src="img/assets/blank_green.png"
            class="image-btn">
      <svg class="image-btn-text" viewBox="0 0 266 160">
        <text x="50%" y="50%">${prompts[resp_mode]['instr_choice']}</text>
      </svg>
    </div>`,
  on_load: function() {
    document.addEventListener('mouseover', handlePress, true);
    document.addEventListener('mouseleave', handleRelease, true);
    document.addEventListener('touchstart', handlePress, { passive: true });
    document.addEventListener('touchend', handleRelease);

    document.addEventListener('mouseup', handleRelease);
  },

  on_finish: function() {
    document.removeEventListener('mouseover', handlePress, true);
    document.removeEventListener('mouseleave', handleRelease, true);
    document.removeEventListener('touchstart', handlePress);
    document.removeEventListener('touchend', handleRelease);

    document.removeEventListener('mouseup', handleRelease);
  },
}

var preload = {
  type: jsPsychPreload,
  images: preload_fnames, // since we use a timeline variable, we can't use the simple "trials"
  show_progress_bar: true,
  show_detailed_erros: true,
  continue_after_error: true,
  on_error: function(fname) {
    console.log('FAILED  '+fname)
  },
  on_finish: function(data) {
    console.log('Preload success? ' + data.success)
    console.log('Failed on ' + data.failed_images.length)
  }
}

var  timeline = [preload, intro, new1, new2, new3, repeat1, lure1, side_by_side1, new4, new5, repeat2, lure2, side_by_side2, outtro];
jsPsych.run(timeline);
    
  
});
</script>

</html>