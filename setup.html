<!doctype html>
<html>
<!--
  You can easily run the oMST without this file. 

  Typically, JATOS studies just run in order, going through whatever tasks you have setup.
  This file lets you define an "order" variable that other tasks can respect to queue up 
  various different tasks or task orders.  You'll see at the end of the experiment code bits
  about seeing if this variable exists and, if so, to use it to queue up the next task.

  Otherwise, this file can be useful as a splash screen or to pre-define some variables, 
  such as the kind of response (button vs. keyboard) to use, what set to use, etc.  You'll
  find that the main experiment code looks in several places (e.g., here, Properties in the
  experiment or in the Batch from JATOS) to let you flexibly override defaults.

-->
<head>
    <script src="js/jquery-3.1.1.min.js"></script>
    <script src="js/jspsych_731/dist/jspsych.js"></script>
    <script src="js/jspsych_731/dist/plugin-preload.js"></script>
    <script src="js/jspsych_731/dist/plugin-html-button-response.js"></script>
    <script src="js/jspsych_731/dist/plugin-html-keyboard-response.js"></script>
    <script src="jatos.js"></script>
    <script src="helpers.js"></script>
  <link rel="stylesheet" href="css/pure-release-0.6.0/pure-min.css">
  <link rel="stylesheet" href="css/jspsych.css"></link>
  <link
    rel="preload"
    href="img/assets/blank_green.png"
    as="image"
  />
  <link
    rel="preload"
    href="img/assets/blank_green_pressed.png"
    as="image"
  />
  <link
    rel="preload"
    href="css/fonts/ComicRelief-Regular.woff2"
    as="font"
    type="font/woff2"
    crossorigin
  />
  <link
    rel="preload"
    href="css/fonts/ComicRelief-Bold.woff2"
    as="font"
    type="font/woff2"
    crossorigin
  />
  <style>
    body {
      margin:0;
      height:100vh;
      display:flex;
      flex-direction:column;
      justify-content:center;
      align-items:center;
      text-align:center;
    }
    
    .image-btn-text text {
      font-size: 1.2em;
      stroke-width: 10;
    }

    .mobile .image-btn-text text{
      stroke-width: 10;
      font-size: 1.2em;
      letter-spacing: 0.12em;
    }

    .image-btn-text.kr text,
    .image-btn-text.ru text{
      font-size: 0.9em;
      stroke-width: 8;
    }

    .image-btn-text.nl  text{
      font-size: 0.8em;
      stroke-width: 8;
    }
    
    .mobile .image-btn-text.kr text {
      font-size: 0.9em;
      stroke-width: 9;
    }

    .mobile .image-btn-text.nl text {
      font-size: 0.8em;
      stroke-width: 8;
    }

    .mobile .image-btn-text.ru text {
      font-size: 1.0em;
      stroke-width: 10;
    }
    
    .tablet .image-btn-text text {
      font-size: 1.3em;
    }

    .tablet .image-btn-text.kr text {
      font-size: 1em;
      stroke-width: 8;
    }

    .tablet .image-btn-text.ru text {
      font-size: 1.0em;
      stroke-width: 10;
    }

    .prompt_text {
      font-size: 2.6em;
    }

    .mobile  .prompt_text {
      font-size: 2em;
    }

    .mobile .prompt_text.nl {
      font-size: 1.8em;
    }

    .mobile .prompt_text.ru {
      font-size: 1.6em;
    }

    .tablet .prompt_text{
      font-size: 1.2em;
    }

    .smallScreen .prompt_text {
      font-size: 2em;
    }

    .tablet .prompt_text.intro {
      font-size: 2em;
    }

    .mobile .prompt_text.es.intro,
    .mobile .prompt_text.nl.intro {
      font-size: 1.8em;
    }

    .mobile .prompt_text.ru.intro {
      font-size: 1.8em;
    }

    .smallScreen .prompt_text.ru.intro {
      font-size: 0.9em;
    }
  </style>
</head>

<body style="text-align: center;">

</body>

<script type="text/javascript">

function getID() {
  // Try to get a reasonable ID code for this person.  You can use the URL with a "sid" parameter or
  // specify one in the jatos studySessionData. If not, it'll use the JATOS workerId.
  // URL > studySession > workerID
  var sid=jatos.urlQueryParameters.sid;
  if (sid == undefined) {
    sid=jatos.studySessionData['sid'];
  }
  if (typeof sid == 'undefined') {
    if (typeof jatos.workerId !== 'undefined') { // At least try the workerID
      sid = jatos.workerId;
    }
    else { sid=1234; }
  }
  return sid
}

jatos.onLoad(async function () {
  // Useful for debugging.  There are a number of options for keeping track of your subject's ID code.
  // JATOS will create their own, but you may have one come in via a URL parameter if you're using
  // something like SONA or Qualtrics.  It might not be "sid" -- it's just what I use.
  //console.log('In setup, URL sid= ' + jatos.urlQueryParameters.sid);

  // We use JATOS' Batch Session to store the number of runs that have been
  // completed and we use this to divvy up the actual counterbalance condition
  // It's a simple, but effective enough scheme for this.  Here, we'll use it
  // to just determine which stimulus set gets used.



  if (!jatos.batchSession.defined("/nruns")) { // If we don't have this field yet, make it
    jatos.batchSession.set("nruns", 0);
  }
  var nruns = jatos.batchSession.get("nruns");
  if (typeof nruns === 'undefined') { // Just catch in case of errors
    var nruns=0;
  }
  var cond = nruns % 2;   // We'll give ourselves just conditions here for 2 stimulus sets

  // But, we'll also let you set JATOS' properties to force a particular condition
  if (jatos.componentJsonInput && typeof jatos.componentJsonInput['force_cond'] !== 'undefined') {
    cond=jatos.componentJsonInput['force_cond'];
    console.log('condition forced via JSON component to ' + cond);
  }

  var order=[5,6]; // Default order skips consent and demographics and does study/test -- will add "end" later
  var include_consent=0;
  var include_demographics=0;
  var include_idcode=0;
  var include_pcon=0;

  // Useful little tags for the experiment and condition that will go into your log files
  var exptag='oMST'
  var condtag='Unk'

  // Setup things for your various counter-balances.  Here, we only have 2 (which set is used)
  switch (cond) {
    case 0: // Stimulus set 1
      jatos.studySessionData['set_omst']=1;
      condtag='oMST-1';
      break;
    case 1: // Stimulus set 2
      jatos.studySessionData['set_omst']=2;
      condtag='oMST-2';
      break;
  }

  // Various manual overrides of that
  let sid=getID();  // Come up with a nice ID number for this person
  var urlsid=0; // Always log this as a backup
  if (typeof jatos.urlQueryParameters.sid !== 'undefined') {
    urlsid = jatos.urlQueryParameters.sid;
  }
  console.log('order: ' + order + '  cond: ' + cond + '  sid: ' + sid);
  // Go stick relevant information in the studySessionData.  Experiment code reads this for the defaults.
  // You can use the various force_XXX options shown in the code to override this (e.g., put a force_set in the
  // JATOS component properties for a task)
  jatos.studySessionData['sid']=sid;
  jatos.studySessionData["order"] = order;  // this is that order of tasks shown, not the order of trials in a task
  jatos.studySessionData["cond"] = cond;
  jatos.studySessionData["taskindex"] = 0;
  jatos.studySessionData['exptag'] = exptag;
  jatos.studySessionData['condtag'] = condtag;

  console.log(include_consent,include_demographics,include_idcode,include_pcon,order)
  // Now, take any possible things we'd see in the JSON input and convert them to studySessionData so
  // that the individual tasks have a consistent spot to find them.
  if (jatos.studyJsonInput && typeof jatos.studyJsonInput['resp_mode'] !== 'undefined') {
    jatos.studySessionData['resp_mode']=jatos.studyJsonInput['resp_mode'];
  }
  if (jatos.studyJsonInput && typeof jatos.studyJsonInput['selfpaced'] !== 'undefined') {
    jatos.studySessionData['selfpaced']=jatos.studyJsonInput['selfpaced'];
  }
  if (typeof jatos.studyJsonInput['set_omst'] !== 'undefined') {
    jatos.studySessionData['set_omst']=jatos.studyJsonInput['set_omst'];
  }
  if (typeof jatos.studyJsonInput['include_demographics'] !== 'undefined') {
    include_demographics=jatos.studyJsonInput['include_demographics'];
    //console.log('study json include demog' + include_demographics);
  }
  if (typeof jatos.studyJsonInput['include_consent'] !== 'undefined') {
    include_consent=jatos.studyJsonInput['include_consent'];
  }
  if (typeof jatos.studyJsonInput['include_idcode'] !== 'undefined') {
    include_idcode=jatos.studyJsonInput['include_idcode'];
  }
  if (typeof jatos.studyJsonInput['include_pcon'] !== 'undefined') {
    include_pcon=jatos.studyJsonInput['include_pcon'];
  }
  if (typeof jatos.studyJsonInput['include_icon'] !== 'undefined') {
    include_pcon=jatos.studyJsonInput['include_icon'];
  }
  if (jatos.studyJsonInput) { console.log('jatos.studyJsonInput: ', jatos.studyJsonInput)}
  console.log(include_consent,include_demographics,include_idcode,include_pcon,order)
  console.log(jatos.studyJsonInput);
  //console.log(jatos.batchProperties.title);
  // Now, let any batch-level bits override those
  if (jatos.batchJsonInput) { console.log('jatos.batchJsonInput: ', jatos.batchJsonInput)}
  if (jatos.batchJsonInput && typeof jatos.batchJsonInput['resp_mode'] !== 'undefined' ) { 
    jatos.studySessionData['resp_mode']=jatos.batchJsonInput['resp_mode'];
  }
  if (jatos.batchJsonInput && typeof jatos.batchJsonInput['set_omst'] !== 'undefined' ) { 
    jatos.studySessionData['set_omst']=jatos.batchJsonInput['set_omst'];
  }
  if (jatos.batchJsonInput && typeof jatos.batchJsonInput['selfpaced'] !== 'undefined' ) { 
    jatos.studySessionData['selfpaced']=jatos.batchJsonInput['selfpaced'];
  }
  if (jatos.batchJsonInput && typeof jatos.batchJsonInput['include_demographics'] !== 'undefined' ) { 
    include_demographics=jatos.batchJsonInput['include_demographics'];
    console.log('include_demographics batch' + include_demographics);
  }
  if (jatos.batchJsonInput && typeof jatos.batchJsonInput['include_consent'] !== 'undefined' ) { 
    include_consent=jatos.batchJsonInput['include_consent'];
  }
  if (jatos.batchJsonInput && typeof jatos.batchJsonInput['include_idcode'] !== 'undefined' ) { 
    include_idcode=jatos.batchJsonInput['include_idcode'];
  }
  if (jatos.batchJsonInput && typeof jatos.batchJsonInput['include_pcon'] !== 'undefined' ) { 
    include_pcon=jatos.batchJsonInput['include_pcon'];
  }
  if (jatos.batchJsonInput && typeof jatos.batchJsonInput['include_icon'] !== 'undefined' ) { 
    include_pcon=jatos.batchJsonInput['include_icon'];
  }
  console.log(include_consent,include_demographics,include_pcon,order)
  
  if (typeof jatos.urlQueryParameters.set_mst !== 'undefined') {
    jatos.studySessionData['set_omst'] = jatos.urlQueryParameters.set_omst;
  }

  if (include_pcon) { order.unshift(8); }
  if (include_demographics) { order.unshift(4); }
  if (include_consent) {order.unshift(3); }
  if (include_idcode) {order.unshift(2); }

  //if (include_pcon) {order.push(6); }
  order.push(7); // Add the "end", which is #7 currently

  if (jatos.studySessionData['set_omst'] == -1) { // randomize the set and subset
    jatos.studySessionData['set_omst'] = Math.floor(Math.random() * 6) + 1;
    jatos.studySessionData['subset'] = Math.floor(Math.random() * 3) + 1;
    console.log('Stimulus set randomized to ',jatos.studySessionData['set_omst'],jatos.studySessionData['subset'])
    
  }
  jatos.studySessionData["order"] = order;
  console.log('Worker ID/sid=' + sid + '  URLSID='+urlsid+'  omst set='+jatos.studySessionData["set_omst"] );
  console.log('order: ' + order);
  //console.log('set: ' + jatos.urlQueryParameters.set_mst);
  console.log('full: ' + jatos.urlQueryParameters)
  console.log("includes: " + include_demographics + include_consent + include_idcode)

  var d= new Date();

  jatos.appendResultData({
    task: "setup-oMST",
    subject: sid,
    urlsid: urlsid,
    selfpaced: jatos.studySessionData['selfpaced'],
    respmode: jatos.studySessionData['resp_mode'],
    oMSTSet: jatos.studySessionData["set_omst"],
    lang: jatos.studySessionData["lang"],
    date: d.toString()
  });

  var classicGraphics = 0;
  if (typeof jatos.studySessionData['plain_graphics'] !== 'undefined') {
    classicGraphics = jatos.studySessionData['plain_graphics'];
  }
  if (jatos.studyJsonInput && typeof jatos.studyJsonInput['plain_graphics'] !== 'undefined' ) { 
    classicGraphics=jatos.studyJsonInput['plain_graphics']
  }
  if (jatos.batchJsonInput && typeof jatos.batchJsonInput['plain_graphics'] !== 'undefined' ) { 
    classicGraphics=jatos.batchJsonInput['plain_graphics']
  }

    // Save for next page load
  localStorage.setItem('classicGraphics', classicGraphics);
  
  // Apply it now
  if (classicGraphics === 1) {
    document.body.style.backgroundColor = '#ffffff';
  } else {
    document.body.style.backgroundColor = '#fff9e0';
  }

  const device = getDeviceType();
  console.log("have device " + device);
  const isMobile = device[0];
  const isTablet = device[1];
  const smallScreen = device[2];
  console.log("smallScreen " + smallScreen);
  const canvasWidth = isMobile ? window.innerWidth * 0.9 : window.innerWidth * .9;
  const canvasHeight = isMobile ? window.innerHeight * 0.7 : smallScreen ? window.innerHeight * 0.75 : isTablet ? window.innerHeight * 0.8 : window.innerHeight * .75;
  const fontScale = isMobile ? 1.5 : 1.0;
  const stimScale = isMobile ? 2 : smallScreen ? 0.85: isTablet ? 1.2 : 1.0;
  document.body.classList.add(isMobile ? 'mobile' : 'desktop');
  if (smallScreen) {document.body.classList.add('smallScreen');}
  if (isTablet) {document.body.classList.add('tablet');}
  if (classicGraphics) {document.body.classList.add('classic');}

  var setup = {
    type: jsPsychHtmlButtonResponse,
    choices: ["Continue"],
    button_html: classicGraphics ? 
      `<div class="image-btn-wrapper">
        <input type="image" src="img/assets/blank_button.png"
              class="image-btn" id="continueButton">
        <svg class="image-btn-text" viewBox="0 0 266 160">
          <text x="50%" y="50%">Continue</text>
        </svg>
      </div>`
    :
      `<div class="image-btn-wrapper">
        <input type="image" src="img/assets/blank_green.png"
              class="image-btn" id="continueButton">
        <svg class="image-btn-text" viewBox="0 0 266 160">
          <text x="50%" y="50%">Continue</text>
        </svg>
      </div>`,
    stimulus: 
    `<p class="prompt_text intro" style="text-align:center;">
      Welcome to the experiment!  
      <br><br><strong>Do not hit your browser's back button or the experiment will terminate</strong>
    </p>`,
    on_load: function() {
      setupButtonListeners();
    },

    on_finish: function() { 
      cleanupButtonListeners();
      
      var nruns = jatos.batchSession.get("nruns");
      jatos.batchSession.set("nruns", nruns+1);
      var order = jatos.studySessionData["order"];
      var d = new Date();
      jatos.studySessionData['datecode'] = d.toLocaleDateString();
      jatos.studySessionData["taskindex"] += 1;
      jatos.startComponentByPos(order[jatos.studySessionData["taskindex"]]);

      console.log('=== VERIFYING CACHE BEFORE NAVIGATION ===');
      const testImages = [
        "img/assets/blank_green.png",
        "img/assets/blank_green_pressed.png",
        "img/assets/blank_red.png",
        "img/assets/blank_red_pressed.png"
      ];
      
      testImages.forEach(src => {
        const img = document.createElement('img');
        img.src = src;
        console.log(`Cache test: ${src} - complete: ${img.complete}`);
      });
      
      // Wait a moment to ensure cache commits before navigating
      setTimeout(() => {
        var nruns = jatos.batchSession.get("nruns");
        jatos.batchSession.set("nruns", nruns+1);
        var order = jatos.studySessionData["order"];
        var d = new Date();
        jatos.studySessionData['datecode'] = d.toLocaleDateString();
        jatos.studySessionData["taskindex"] += 1;
        jatos.startComponentByPos(order[jatos.studySessionData["taskindex"]]);
      }, 100); // Small delay to ensure cache commits
    },
  }

  var timeline = [setup];
  var jsPsych = initJsPsych({
    on_finish: function() {
      // Optional: what to do when experiment finishes
    }
  });
  jsPsych.run(timeline);
});

// Add event listeners once DOM is ready
document.addEventListener("DOMContentLoaded", () => {
  const wrapper = document.querySelector('.image-btn-wrapper');

  // Mouse hover
  wrapper.addEventListener('mouseenter', handlePress, true);
  wrapper.addEventListener('mouseleave', handleRelease, true);

  // Touch
  wrapper.addEventListener('touchstart', handlePress, { passive: true });
  wrapper.addEventListener('touchend', handleRelease);

  // Fallback for mouseup anywhere
  document.addEventListener('mouseup', handleRelease);
});



</script>

</html>
