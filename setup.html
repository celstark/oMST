<!doctype html>
<html>
<!--
  You can easily run the oMST without this file. 

  Typically, JATOS studies just run in order, going through whatever tasks you have setup.
  This file lets you define an "order" variable that other tasks can respect to queue up 
  various different tasks or task orders.  You'll see at the end of the experiment code bits
  about seeing if this variable exists and, if so, to use it to queue up the next task.

  Otherwise, this file can be useful as a splash screen or to pre-define some variables, 
  such as the kind of response (button vs. keyboard) to use, what set to use, etc.  You'll
  find that the main experiment code looks in several places (e.g., here, Properties in the
  experiment or in the Batch from JATOS) to let you flexibly override defaults.

-->
<head>
    <script src="js/jquery-3.1.1.min.js"></script>
    <script src="jatos.js"></script>
  <link rel="stylesheet" href="css/pure-release-0.6.0/pure-min.css">
  <link rel="stylesheet" href="css/jspsych.css"></link>
  <style>
    body {
      margin:0;
      height:100vh;
      display:flex;
      flex-direction:column;
      justify-content:center;
      align-items:center;
      text-align:center;
      background-color: #fff9e0;
    }

    .jspsych-display-element {
      font-size: 200%;
    }
    .jspsych-btn {
      font-size: 150%;
    }

    .image-btn-wrapper {
      display: inline-block;
      position: relative;
      margin: 0.5em;
    }

    .image-btn {
      width: 15vw;
      height: auto;
      border: none;
      display: block;
    }

    .smallScreen .image-btn {
      width: 20vw !important;
    }

    .mobile .image-btn {
      width: 35vw;
    }

    .tablet .image-btn {
      width: 25vw;
    }

    .image-btn-text {
      position: absolute;
      top: 38%;
      left: 50%;
      transform: translate(-50%, -50%);
      pointer-events: none;
      width: 100%;
      height: auto; /* scales with wrapper if you want */
    }

    .image-btn-text text {
      font-family: 'Comic Relief', sans-serif;
      font-size: 2em;
      fill: #fff8d6;       /* inner text color */
      stroke: #5d2b12;     /* outline color */
      stroke-width: 10;     /* outline thickness */
      font-weight: bold;
      letter-spacing: 0.08em;
      text-anchor: middle;
      dominant-baseline: middle;
      paint-order: stroke fill;
      stroke-linejoin: round;
      stroke-linecap: round;
    }
    
    .image-btn-wrapper.pressed .image-btn-text{
      transform: translate(-50%, -40%) !important;
    }

    .mobile .image-btn-text text{
      stroke-width: 12;
      font-size: 2.2em;
      letter-spacing: 0.12em;
    }

    .image-btn-text.kr text,
    .image-btn-text.ru text{
      font-size: 0.9em;
      stroke-width: 8;
    }

    .image-btn-text.nl  text{
      font-size: 0.8em;
      stroke-width: 8;
    }
    
    .mobile .image-btn-text.kr text {
      font-size: 0.9em;
      stroke-width: 9;
    }

    .mobile .image-btn-text.nl text {
      font-size: 0.8em;
      stroke-width: 8;
    }

    .mobile .image-btn-text.ru text {
      font-size: 1.0em;
      stroke-width: 10;
    }
    
    .tablet .image-btn-text.kr text {
      font-size: 1em;
      stroke-width: 8;
    }

    .tablet .image-btn-text.ru text {
      font-size: 1.0em;
      stroke-width: 10;
    }

    body {
      background-color: #fff9e0;
    }

    .prompt_text {
      font-family: 'Comic Relief', sans-serif;
      font-size: 2.6em;
      color: #5d2b12;
      font-weight: normal;
      line-height: 1.2;
    }

    .mobile  .prompt_text {
      font-size: 3em;
    }

    .mobile .prompt_text.nl {
      font-size: 1.8em;
    }

    .mobile .prompt_text.ru {
      font-size: 1.6em;
    }

    .tablet .prompt_text{
      font-size: 1.2em;
    }

    .smallScreen .prompt_text {
      font-size: 2.6em;
    }

    .tablet .prompt_text.intro {
      font-size: 2.6em;
    }

    .mobile .prompt_text.es.intro,
    .mobile .prompt_text.nl.intro {
      font-size: 1.8em;
    }

    .mobile .prompt_text.ru.intro {
      font-size: 1.8em;
    }

    .smallScreen .prompt_text.ru.intro {
      font-size: 0.9em;
    }
  </style>
</head>

<body style="text-align: center;">
  <p class="prompt_text intro" style="text-align:center;">
    Welcome to the experiment!  
    <br><br><strong>Do not hit your browser's back button or the experiment will terminate</strong>
  </p>

  <div class="image-btn-wrapper">
    <input type="image" src="img/assets/blank_green.png"
          class="image-btn"
          id="continueButton">
    <svg class="image-btn-text" viewBox="0 0 266 160">
      <text x="50%" y="50%">Continue</text>
    </svg>
  </div>
</body>

<script type="text/javascript">

const isMobile = /Mobi|Android/i.test(navigator.userAgent);
const isTablet = window.innerWidth >= 600 && window.innerWidth <= 1024 && !isMobile;
const smallScreen = window.innerHeight <= 800 && window.innerWidth <= 1440 && !isMobile && !isTablet;
const canvasWidth = isMobile ? window.innerWidth * 0.9 : window.innerWidth * .9;
const canvasHeight = isMobile ? window.innerHeight * 0.7 : smallScreen ? window.innerHeight * 0.8 : window.innerHeight * .65;
const fontScale = isMobile ? 1.5 : 1.0;
const stimScale = isMobile ? 0.9 : smallScreen ? 0.85: isTablet ? 0.8 : 0.9;
document.body.classList.add(isMobile ? 'mobile' : 'desktop');
if (smallScreen) {document.body.classList.add('smallScreen');}
if (isTablet) {document.body.classList.add('tablet');}

function getID() {
  // Try to get a reasonable ID code for this person.  You can use the URL with a "sid" parameter or
  // specify one in the jatos studySessionData. If not, it'll use the JATOS workerId.
  // URL > studySession > workerID
  var sid=jatos.urlQueryParameters.sid;
  if (sid == undefined) {
    sid=jatos.studySessionData['sid'];
  }
  if (typeof sid == 'undefined') {
    if (typeof jatos.workerId !== 'undefined') { // At least try the workerID
      sid = jatos.workerId;
    }
    else { sid=1234; }
  }
  return sid
}
jatos.onLoad(function () {
  // Useful for debugging.  There are a number of options for keeping track of your subject's ID code.
  // JATOS will create their own, but you may have one come in via a URL parameter if you're using
  // something like SONA or Qualtrics.  It might not be "sid" -- it's just what I use.
  //console.log('In setup, URL sid= ' + jatos.urlQueryParameters.sid);

  // We use JATOS' Batch Session to store the number of runs that have been
  // completed and we use this to divvy up the actual counterbalance condition
  // It's a simple, but effective enough scheme for this.  Here, we'll use it
  // to just determine which stimulus set gets used.
  if (!jatos.batchSession.defined("/nruns")) { // If we don't have this field yet, make it
    jatos.batchSession.set("nruns", 0);
  }
  var nruns = jatos.batchSession.get("nruns");
  if (typeof nruns === 'undefined') { // Just catch in case of errors
    var nruns=0;
  }
  var cond = nruns % 2;   // We'll give ourselves just conditions here for 2 stimulus sets

  // But, we'll also let you set JATOS' properties to force a particular condition
  if (jatos.componentJsonInput && typeof jatos.componentJsonInput['force_cond'] !== 'undefined') {
    cond=jatos.componentJsonInput['force_cond'];
    console.log('condition forced via JSON component to ' + cond);
  }

  var order=[5,6]; // Default order skips consent and demographics and does study/test -- will add "end" later
  var include_consent=0;
  var include_demographics=0;
  var include_idcode=0;
  var include_pcon=0;

  // Useful little tags for the experiment and condition that will go into your log files
  var exptag='oMST'
  var condtag='Unk'

  // Setup things for your various counter-balances.  Here, we only have 2 (which set is used)
  switch (cond) {
    case 0: // Stimulus set 1
      jatos.studySessionData['set_omst']=1;
      condtag='oMST-1';
      break;
    case 1: // Stimulus set 2
      jatos.studySessionData['set_omst']=2;
      condtag='oMST-2';
      break;
  }

  // Various manual overrides of that
  let sid=getID();  // Come up with a nice ID number for this person
  var urlsid=0; // Always log this as a backup
  if (typeof jatos.urlQueryParameters.sid !== 'undefined') {
    urlsid = jatos.urlQueryParameters.sid;
  }
  console.log('order: ' + order + '  cond: ' + cond + '  sid: ' + sid);
  // Go stick relevant information in the studySessionData.  Experiment code reads this for the defaults.
  // You can use the various force_XXX options shown in the code to override this (e.g., put a force_set in the
  // JATOS component properties for a task)
  jatos.studySessionData['sid']=sid;
  jatos.studySessionData["order"] = order;  // this is that order of tasks shown, not the order of trials in a task
  jatos.studySessionData["cond"] = cond;
  jatos.studySessionData["taskindex"] = 0;
  jatos.studySessionData['exptag'] = exptag;
  jatos.studySessionData['condtag'] = condtag;

  console.log(include_consent,include_demographics,include_idcode,include_pcon,order)
  // Now, take any possible things we'd see in the JSON input and convert them to studySessionData so
  // that the individual tasks have a consistent spot to find them.
  if (jatos.studyJsonInput && typeof jatos.studyJsonInput['resp_mode'] !== 'undefined') {
    jatos.studySessionData['resp_mode']=jatos.studyJsonInput['resp_mode'];
  }
  if (jatos.studyJsonInput && typeof jatos.studyJsonInput['selfpaced'] !== 'undefined') {
    jatos.studySessionData['selfpaced']=jatos.studyJsonInput['selfpaced'];
  }
  if (typeof jatos.studyJsonInput['set_omst'] !== 'undefined') {
    jatos.studySessionData['set_omst']=jatos.studyJsonInput['set_omst'];
  }
  if (typeof jatos.studyJsonInput['include_demographics'] !== 'undefined') {
    include_demographics=jatos.studyJsonInput['include_demographics'];
    //console.log('study json include demog' + include_demographics);
  }
  if (typeof jatos.studyJsonInput['include_consent'] !== 'undefined') {
    include_consent=jatos.studyJsonInput['include_consent'];
  }
  if (typeof jatos.studyJsonInput['include_idcode'] !== 'undefined') {
    include_idcode=jatos.studyJsonInput['include_idcode'];
  }
  if (typeof jatos.studyJsonInput['include_pcon'] !== 'undefined') {
    include_pcon=jatos.studyJsonInput['include_pcon'];
  }
  if (typeof jatos.studyJsonInput['include_icon'] !== 'undefined') {
    include_pcon=jatos.studyJsonInput['include_icon'];
  }
  if (jatos.studyJsonInput) { console.log('jatos.studyJsonInput: ', jatos.studyJsonInput)}
  console.log(include_consent,include_demographics,include_idcode,include_pcon,order)
  console.log(jatos.studyJsonInput);
  //console.log(jatos.batchProperties.title);
  // Now, let any batch-level bits override those
  if (jatos.batchJsonInput) { console.log('jatos.batchJsonInput: ', jatos.batchJsonInput)}
  if (jatos.batchJsonInput && typeof jatos.batchJsonInput['resp_mode'] !== 'undefined' ) { 
    jatos.studySessionData['resp_mode']=jatos.batchJsonInput['resp_mode'];
  }
  if (jatos.batchJsonInput && typeof jatos.batchJsonInput['set_omst'] !== 'undefined' ) { 
    jatos.studySessionData['set_omst']=jatos.batchJsonInput['set_omst'];
  }
  if (jatos.batchJsonInput && typeof jatos.batchJsonInput['selfpaced'] !== 'undefined' ) { 
    jatos.studySessionData['selfpaced']=jatos.batchJsonInput['selfpaced'];
  }
  if (jatos.batchJsonInput && typeof jatos.batchJsonInput['include_demographics'] !== 'undefined' ) { 
    include_demographics=jatos.batchJsonInput['include_demographics'];
    console.log('include_demographics batch' + include_demographics);
  }
  if (jatos.batchJsonInput && typeof jatos.batchJsonInput['include_consent'] !== 'undefined' ) { 
    include_consent=jatos.batchJsonInput['include_consent'];
  }
  if (jatos.batchJsonInput && typeof jatos.batchJsonInput['include_idcode'] !== 'undefined' ) { 
    include_idcode=jatos.batchJsonInput['include_idcode'];
  }
  if (jatos.batchJsonInput && typeof jatos.batchJsonInput['include_pcon'] !== 'undefined' ) { 
    include_pcon=jatos.batchJsonInput['include_pcon'];
  }
  if (jatos.batchJsonInput && typeof jatos.batchJsonInput['include_icon'] !== 'undefined' ) { 
    include_pcon=jatos.batchJsonInput['include_icon'];
  }
  console.log(include_consent,include_demographics,include_pcon,order)
  
  if (typeof jatos.urlQueryParameters.set_mst !== 'undefined') {
    jatos.studySessionData['set_omst'] = jatos.urlQueryParameters.set_omst;
  }

  if (include_pcon) { order.unshift(8); }
  if (include_demographics) { order.unshift(4); }
  if (include_consent) {order.unshift(3); }
  if (include_idcode) {order.unshift(2); }

  //if (include_pcon) {order.push(6); }
  order.push(7); // Add the "end", which is #7 currently

  if (jatos.studySessionData['set_omst'] == -1) { // randomize the set and subset
    jatos.studySessionData['set_omst'] = Math.floor(Math.random() * 6) + 1;
    jatos.studySessionData['subset'] = Math.floor(Math.random() * 3) + 1;
    console.log('Stimulus set randomized to ',jatos.studySessionData['set_omst'],jatos.studySessionData['subset'])
    
  }
  jatos.studySessionData["order"] = order;
  console.log('Worker ID/sid=' + sid + '  URLSID='+urlsid+'  omst set='+jatos.studySessionData["set_omst"] );
  console.log('order: ' + order);
  //console.log('set: ' + jatos.urlQueryParameters.set_mst);
  console.log('full: ' + jatos.urlQueryParameters)
  console.log("includes: " + include_demographics + include_consent + include_idcode)

  var d= new Date();

  jatos.appendResultData({
    task: "setup-oMST",
    subject: sid,
    urlsid: urlsid,
    selfpaced: jatos.studySessionData['selfpaced'],
    respmode: jatos.studySessionData['resp_mode'],
    oMSTSet: jatos.studySessionData["set_omst"],
    lang: jatos.studySessionData["lang"],
    date: d.toString()
  });

  $('#continueButton').prop('disabled', false);
});

$('#continueButton').click(function () {
  var nruns = jatos.batchSession.get("nruns");
  jatos.batchSession.set("nruns", nruns+1);
  var order=jatos.studySessionData["order"];
  var d = new Date();
  jatos.studySessionData['datecode']=d.toLocaleDateString();
  jatos.startComponentByPos(order[0],jatos.studySessionData);
});

let activeBtn = null;

function handlePress(e) {
  const wrapper = e.target.closest('.image-btn-wrapper');
  if (!wrapper) return;

  const btn = wrapper.querySelector('.image-btn');
  const origSrc = btn.dataset.orig || btn.src;
  const pressedSrc = btn.dataset.pressed || origSrc.replace('.png', '_pressed.png');

  btn.dataset.orig = origSrc;
  btn.dataset.pressed = pressedSrc;

  btn.src = pressedSrc;
  wrapper.classList.add('pressed');

  activeBtn = btn;  // remember which button is pressed
}

function handleRelease(e) {
  if (!activeBtn) {
    return; // nothing to release
  }
  const wrapper = activeBtn.closest('.image-btn-wrapper');
  activeBtn.src = activeBtn.dataset.orig;
  wrapper.classList.remove('pressed');

  activeBtn = null; // reset
}

// Add event listeners once DOM is ready
document.addEventListener("DOMContentLoaded", () => {
  const wrapper = document.querySelector('.image-btn-wrapper');

  // Mouse hover
  wrapper.addEventListener('mouseenter', handlePress, true);
  wrapper.addEventListener('mouseleave', handleRelease, true);

  // Touch
  wrapper.addEventListener('touchstart', handlePress, { passive: true });
  wrapper.addEventListener('touchend', handleRelease);

  // Fallback for mouseup anywhere
  document.addEventListener('mouseup', handleRelease);
});

</script>

</html>
